var app=angular.module("yopresto",["ui.router","ui.bootstrap","duScroll","pascalprecht.translate","ngCookies","angulartics","angulartics.google.analytics","AboutPageCtrl","PageService","MainCtrl","HomeCtrl","LoginCtrl","RegisterCtrl","VerifyCtrl","ThankYouCtrl","ForgotCtrl","RecoverCtrl","PricingCtrl","PublicCtrl","VideoLandingModalCtrl"]);app.config(["$stateProvider","$urlRouterProvider","$locationProvider","$translateProvider","$httpProvider",function(e,t,a,n,r){n.useLocalStorage(),n.useStaticFilesLoader({prefix:"/languages/app/",suffix:".json"}),n.preferredLanguage("es"),n.useSanitizeValueStrategy("escape"),t.otherwise("/"),r.defaults.withCredentials=!0,e.state("public",{url:"/:lang",abstract:!0,controller:"PublicController",templateUrl:"views/_public.html"}).state("public.thankyou",{url:"/thankyou",controller:"ThankYouController",templateUrl:"views/_thank-you.html"}).state("public.login",{url:"/login",templateUrl:"views/_login.html",controller:"LoginController"}).state("public.register",{url:"/register",templateUrl:"views/_register.html",controller:"RegisterController"}).state("verify",{url:"/verify",templateUrl:"views/_verify.html",controller:"VerifyController"}).state("verifyCode",{url:"/verify/:code",templateUrl:"views/_verify.html",controller:"VerifyController"}).state("public.forgot",{url:"/forgot",templateUrl:"views/_forgot.html",controller:"ForgotController"}).state("recover",{url:"/recover/:token",templateUrl:"views/_recover.html",controller:"RecoverController"}).state("public.pricing",{url:"/pricing",templateUrl:"views/_pricing.html",controller:"PricingController"}).state("terms-spanish",{url:"/es/terms",templateUrl:"views/_terms_es.html"}).state("terms-english",{url:"/en/terms",templateUrl:"views/_terms_en.html"}).state("public.features",{url:"/features",templateUrl:"views/_features.html",controller:"AboutPageController"}).state("public.home",{url:"",templateUrl:"views/_home.html",controller:"HomeController"}).state("public.seo-killer-es",{url:"/programa-software-para-casas-de-empeno",templateUrl:"views/_home.html",controller:"HomeController"}).state("public.seo-killer-en",{url:"/best-software-for-pawn-shops",templateUrl:"views/_home.html",controller:"HomeController"}),a.html5Mode(!0),a.hashPrefix("!")}]).run(["$window","$rootScope",function(e,t){t.$on("$viewContentLoaded",function(){var e=setInterval(function(){"complete"===document.readyState&&(window.scrollTo(0,0),clearInterval(e))},1)})}]);(app=angular.module("ypDashboard",["ui.router","ui.bootstrap","duScroll","ngAnimate","ngCookies","angular-directive-percentage","toastr","tmh.dynamicLocale","ngFileUpload","pascalprecht.translate","angulartics","angulartics.google.analytics","AccessHoursCtrl","ActiveLayawaysReportCtrl","ActiveLoansReportCtrl","ActiveLoansOCIFCtrl","BranchCtrl","BranchSelectionCtrl","LockCtrl","BranchSettingsCtrl","CategoryCtrl","CashflowCtrl","CashModalCtrl","ClientCtrl","ClientEditOrCreateCtrl","ClientDetailsCtrl","ClientReportCtrl","CompanyCtrl","CompanyInfoCtrl","CompanyInvoicingCtrl","CompanyBillingCtrl","CompanyBranchesCtrl","CompanyTicketCtrl","DashboardCtrl","DueSoonLoansReportCtrl","DummyCtrl","ExpiredLoansReportCtrl","HaveQuestionCtrl","MeltedReportCtrl","InventoryCtrl","InventoryReportCtrl","ItemDetailsCtrl","ItemEditCtrl","ItemSellModalCtrl","LayawayCategoryCtrl","LayawayReceiptCtrl","LoanBalanceCtrl","LoanCreateCtrl","LoanCtrl","LoanPaymentReceiptCtrl","LoanDetailsCtrl","MetalCtrl","MetalDetailsCtrl","OverdueLayawaysReportCtrl","OverdueLoansReportCtrl","PageService","PasswordDialogCtrl","PaymentCtrl","PurchaseCtrl","PurchaseReceiptCtrl","PurchasesReportCtrl","ReceiptCtrl","ReportCtrl","SummaryCtrl","SaleReceiptCtrl","SalesReportCtrl","SettledLoansReportCtrl","SubscribeCtrl","TicketEditCtrl","TicketCtrl","UpgradeModalCtrl","WebcamCtrl","WelcomeCtrl","YesNoCtrl"])).config(["$stateProvider","$urlRouterProvider","$locationProvider","$compileProvider","toastrConfig","tmhDynamicLocaleProvider","$translateProvider","$httpProvider",function(e,t,a,n,r,o,i,c){i.useStaticFilesLoader({prefix:"/languages/dashboard/",suffix:".json"}),i.preferredLanguage("es"),i.useSanitizeValueStrategy("escape"),n.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|javascript):/),o.localeLocationPattern("/lib/angular-i18n/angular-locale_{{ locale }}.js"),angular.extend(r,{closeButton:!0}),t.otherwise("/404"),c.defaults.withCredentials=!0,e.state("home",{url:"/",templateUrl:"views/_branch-selection.html",controller:"BranchSelectionController",controllerAs:"vm"}).state("login-redirect",{url:"/login",templateUrl:"views/_branch.html",controller:"BranchController"}).state("branch",{url:"/branch/:branchId",abstract:!0,templateUrl:"views/_branch.html",controller:"BranchController"}).state("branch.locked",{url:"/locked",templateUrl:"views/_lock-screen.html",controller:"LockController",controllerAs:"vm"}).state("branch.settings",{url:"/settings",templateUrl:"views/_branch-settings.html",controller:"BranchSettingsController"}).state("branch.clients",{url:"/clients",templateUrl:"views/_clients.html",controller:"ClientController",reloadOnSearch:!1}).state("branch.client-new",{url:"/client/new",templateUrl:"views/_client-edit-or-create.html",controller:"ClientEditOrCreateController"}).state("branch.client-edit",{url:"/client/:clientId/edit",templateUrl:"views/_client-edit-or-create.html",controller:"ClientEditOrCreateController"}).state("branch.client",{url:"/client/:clientId",templateUrl:"views/_client-details.html",controller:"ClientDetailsController"}).state("branch.loan-new",{url:"/client/:clientId/loan",templateUrl:"views/_loan-create.html",controller:"LoanCreateController"}).state("branch.purchase",{url:"/client/:clientId/purchase",templateUrl:"views/_purchase.html",controller:"PurchaseController"}).state("branch.loan",{url:"/loan/:loanId",templateUrl:"views/_loan-details.html",controller:"LoanDetailsController"}).state("branch.loans",{url:"/loans",templateUrl:"views/_loans.html",controller:"LoanController"}).state("branch.item",{url:"/item/:itemId",templateUrl:"views/_item-details.html",controller:"ItemDetailsController"}).state("branch.item-edit",{url:"/item/:itemId/edit",templateUrl:"views/_item-edit.html",controller:"ItemEditController"}).state("branch.inventory",{url:"/inventory",templateUrl:"views/_inventory.html",controller:"InventoryController"}).state("branch.metals",{url:"/metals",templateUrl:"views/_metals.html",controller:"MetalController",controllerAs:"vm"}).state("branch.metal",{url:"/metal/:metalId",templateUrl:"views/_metal-details.html",controller:"MetalDetailsController",controllerAs:"vm"}).state("branch.history",{url:"/history",templateUrl:"views/_history.html",controller:"InventoryController"}).state("branch.reports",{url:"/reports",templateUrl:"views/_reports.html",controller:"ReportController",controllerAs:"vm"}).state("branch.activeLoansReport",{url:"/reports/activeLoans",templateUrl:"views/reports/_active-loans.html",controller:"ActiveLoansReportController",controllerAs:"vm"}).state("branch.activeLoansOCIF",{url:"/reports/activeLoansOCIF",templateUrl:"views/reports/_active-loans-ocif.html",controller:"ActiveLoansOCIFController",controllerAs:"vm"}).state("branch.overdueLoansReport",{url:"/reports/overdueLoans",templateUrl:"views/reports/_overdue-loans.html",controller:"OverdueLoansReportController",controllerAs:"vm"}).state("branch.dueSoonLoansReport",{url:"/reports/dueSoonLoans",templateUrl:"views/reports/_due-soon-loans.html",controller:"DueSoonLoansReportController",controllerAs:"vm"}).state("branch.expiredLoansReport",{url:"/reports/expiredLoans",templateUrl:"views/reports/_expired-loans.html",controller:"ExpiredLoansReportController",controllerAs:"vm"}).state("branch.settledLoansReport",{url:"/reports/settledLoans",templateUrl:"views/reports/_settled-loans.html",controller:"SettledLoansReportController",controllerAs:"vm"}).state("branch.purchasesReport",{url:"/reports/purchases",templateUrl:"views/reports/_purchases.html",controller:"PurchasesReportController",controllerAs:"vm"}).state("branch.salesReport",{url:"/reports/sales",templateUrl:"views/reports/_sales.html",controller:"SalesReportController",controllerAs:"vm"}).state("branch.activeLayawaysReport",{url:"/reports/activeLayaways",templateUrl:"views/reports/_active-layaways.html",controller:"ActiveLayawaysReportController",controllerAs:"vm"}).state("branch.overdueLayawaysReport",{url:"/reports/overdueLayaways",templateUrl:"views/reports/_overdue-layaways.html",controller:"OverdueLayawaysReportController",controllerAs:"vm"}).state("branch.inventoryReport",{url:"/reports/inventory?status&type",templateUrl:"views/reports/_inventory.html",controller:"InventoryReportController",controllerAs:"vm"}).state("branch.MeltedReport",{url:"/reports/melted?status",templateUrl:"views/reports/_melted.html",controller:"MeltedReportController",controllerAs:"vm"}).state("branch.clientsReport",{url:"/reports/clients/:reportType",templateUrl:"views/reports/_clients.html",controller:"ClientReportController",controllerAs:"vm"}).state("branch.cashflow",{url:"/cashflow",templateUrl:"views/_cashflow.html",controller:"CashflowController",controllerAs:"vm"}).state("branch.summary",{url:"/summary",templateUrl:"views/_summary.html",controller:"SummaryController",controllerAs:"vm"}).state("receipt",{url:"/branch/:branchId",abstract:!0,templateUrl:"views/receipts/_receipt.html",controller:"ReceiptController",controllerAs:"receipt"}).state("receipt.layawayReceipt",{url:"/item/:itemId/layawayReceipt",templateUrl:"views/receipts/_layaway.html",controller:"LayawayReceiptController",controllerAs:"vm"}).state("receipt.saleReceipt",{url:"/item/:itemId/saleReceipt",templateUrl:"views/receipts/_sale.html",controller:"SaleReceiptController",controllerAs:"vm"}).state("receipt.purchaseReceipt",{url:"/item/:itemId/purchaseReceipt",templateUrl:"views/receipts/_purchase.html",controller:"PurchaseReceiptController",controllerAs:"vm"}).state("receipt.loanPaymentReceipt",{url:"/loan/:loanId/receipt",templateUrl:"views/receipts/_loanPayment.html",controller:"LoanPaymentReceiptController",controllerAs:"vm"}).state("receipt.loanBalance",{url:"/loan/:loanId/balance",templateUrl:"views/receipts/_loanBalance.html",controller:"LoanBalanceController",controllerAs:"vm"}).state("company",{url:"/company",templateUrl:"views/_company.html",controller:"CompanyController",controllerAs:"companyVM",abstract:!0}).state("company.info",{url:"/info",templateUrl:"views/_company-info.html",controller:"CompanyInfoController",controllerAs:"info"}).state("company.billing",{url:"/billing",templateUrl:"views/_company-billing.html",controller:"CompanyBillingController",controllerAs:"vm"}).state("company.invoicing",{url:"/invoicing",templateUrl:"views/_company-invoicing.html",controller:"CompanyInvoicingController",controllerAs:"vm"}).state("company.branches",{url:"/branches",templateUrl:"views/_company-branches.html",controller:"CompanyBranchesController",controllerAs:"branches"}).state("company.ticket",{url:"/ticket",templateUrl:"views/_company-ticket.html",controller:"CompanyTicketController",controllerAs:"vm"}).state("subscribe",{url:"/subscribe",templateUrl:"views/_subscribe.html",controller:"SubscribeController",controllerAs:"vm"}).state("ticket-edit",{url:"/company/ticket/edit",templateUrl:"views/_ticket-edit.html",controller:"TicketEditController",controllerAs:"ticket"}).state("ticket",{url:"/branch/:branchId/loan/:loanId/ticket",templateUrl:"views/_ticket.html",controller:"TicketController",controllerAs:"vm"}).state("payment-method",{url:"/company/payment",templateUrl:"views/_company-payment.html",controller:"CompanyPaymentController",controllerAs:"vm"}).state("payment-success",{url:"/company/payment/success",templateUrl:"views/_payment-success.html"}).state("pricing",{url:"/pricing",templateUrl:"views/_pricing.html"}).state("terms",{url:"/terms",templateUrl:"views/_terms_spa.html"}).state("404",{url:"/404",templateUrl:"views/_404.html"}).state("dummy",{url:"/dummy",templateUrl:"views/_dummy.html",controller:"DummyController"}),a.html5Mode(!0),a.hashPrefix("!")}]).run(["$window","$rootScope",function(e,t){t.$on("$viewContentLoaded",function(){var e=setInterval(function(){"complete"===document.readyState&&(window.scrollTo(0,0),clearInterval(e))},1)})}]),angular.module("PopDirective",["ui.bootstrap"]).directive("popPopup",[function(){return{restrict:"EA",replace:!0,scope:{title:"@",content:"@",placement:"@",animation:"&",remove:"&",save:"&",isOpen:"&"},templateUrl:"/views/_ticket-field-popover.html"}}]).directive("pop",["$tooltip","$timeout",function(e,n){var e=e("pop","pop","event"),r=angular.copy(e.compile);return e.compile=function(t,e){var a=!0;return e.$observe("popShow",function(e){JSON.parse(!a||e||!1)&&n(function(){t.triggerHandler("event")}),a=!1}),r(t,e)},e}]),angular.module("yp.directives.ypFieldPop",["TicketService"]).directive("ypFieldPop",["$timeout","Ticket",function(n,r){return{restrict:"E",replace:!0,templateUrl:"/views/_ticket-field-popover.html",scope:{remove:"&",ok:"&",close:"&",field:"=",template:"="},link:function(e,t,a){e.availableFields=r.availableFields,n(function(){t.css({top:t.parent()[0].offsetHeight/2-t[0].offsetHeight/2+"px"})})}}}]).directive("ypTicketField",["$timeout","Ticket",function(e,n){return{restrict:"E",replace:!0,templateUrl:"/views/_ticket-field.html",scope:{remove:"&",ok:"&",close:"&",alwaysOpen:"=",field:"=",editable:"="},link:function(t,e,a){t.isPopOpen=t.alwaysOpen||!1,t.vm={},!t.alwaysOpen&&t.editable&&(t.fieldClicked=function(){t.isPopOpen=!t.isPopOpen}),a.close||(t.close=function(){t.isPopOpen=!1}),a.ok||t.alwaysOpen||(t.ok=function(){t.isPopOpen=!1}),t.editable?(t.vm.template=n.availableFields.filter(function(e){return e.id===t.field.variable})[0],t.$watchCollection("vm.template.id",function(e){e&&(t.field.variable=e)})):t.vm.template=t.field}}}]),angular.module("AboutPageCtrl",[]).controller("AboutPageController",["$scope","Page",function(e,t){(e.Page=t).name="about"}]),angular.module("AccessHoursCtrl",[]).controller("AccessHoursController",["$scope","$uibModalInstance","$locale","accessHours",function(a,t,e,n){a.accessHours=n,a.cancel=t.dismiss,a.save=function(){var e=a.weekdays.filter(function(e){return e.isActive}).map(function(e){return{day:e.day,startsAt:e.startsAt,endsAt:e.endsAt}});t.close(e)},a.weekdays=[],e.DATETIME_FORMATS.SHORTDAY.forEach(function(e,t){a.weekdays.push({day:t,name:e,isActive:!1,startsAt:9,endsAt:17})}),a.hours=[];for(var r=0;r<24;r++)0===r?a.hours.push({code:r,name:"12 am"}):12===r?a.hours.push({code:r,name:"12 pm"}):a.hours.push({code:r,name:r<12?o(r)+" am":o(r-12)+" pm"});function o(e){e="0"+e;return e.substr(e.length-2)}a.getEndHours=function(t){return a.hours.filter(function(e){return e.code>t})},a.accessHours&&a.accessHours.forEach(function(e){var t=a.weekdays[e.day];t.isActive=!0,t.startsAt=e.startsAt,t.endsAt=e.endsAt})}]),angular.module("ActiveLayawaysReportCtrl",["ReportService"]).controller("ActiveLayawaysReportController",["$scope","$window","Report",function(e,t,a){var n=this;function r(){n.branch=e.branch,a.getActiveLayaways(n.branch._id).then(function(e){n.isLoading=!1,n.items=e.data.items,i()},function(e){n.isLoading=!1,n.error=e.err.message})}function o(){return moment().startOf("day").subtract(n.daysAgo,"days").toDate()}function i(){n.items&&(n.totalPrice=0,n.totalCredited=0,n.totalBalance=0,n.count=0,n.items.forEach(function(e){(!n.isFiltered||new Date(e.layaway.createdAt)>n.until)&&(n.count++,n.totalPrice+=e.price,n.totalCredited+=e.layaway.credited,n.totalBalance+=e.layaway.balance)}))}n.today=new Date,n.isFiltered=!1,n.daysAgo=7,n.until=o(),n.isLoading=!0,e.branch.name?r():e.$on("branchLoaded",function(){r()}),n.changeDaysAgo=function(){n.daysAgo?(n.until=o(),i()):n.until=null},n.filterDaysAgo=function(e){return!n.isFiltered||(!n.until||new Date(e.layaway.createdAt)>n.until)},n.print=function(){t.print()}}]),angular.module("ActiveLoansOCIFCtrl",["ReportService"]).controller("ActiveLoansOCIFController",["$scope","$timeout","$window","Report",function(e,t,a,n){var r=this;function o(){t(function(){var e=new Date;r.min=moment().subtract(3,"month").toDate(),r.max=e,r.isLoading=!1},300),r.branch=e.branch}r.isLoading=!0,e.branch.name?o():e.$on("branchLoaded",function(){o()}),r.reportUrl=function(){return r.min&&r.max?"activeLoansOCIF?from="+moment(r.min).startOf("day").toISOString()+"&to="+moment(r.max).startOf("day").toISOString():""},r.openMinPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMinPickerOpen=!r.isMinPickerOpen},r.openMaxPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMaxPickerOpen=!r.isMaxPickerOpen}}]),angular.module("ActiveLoansReportCtrl",["ReportService"]).controller("ActiveLoansReportController",["$scope","$timeout","$window","Report",function(e,t,a,n){var r=this;function o(){t(function(){var e=new Date;r.min=moment().subtract(3,"month").toDate(),r.max=e,n.getActiveLoans(r.branch._id).then(function(e){r.isLoading=!1,r.loans=e.data.loans,r.updateTotals()}).catch(function(e){r.isLoading=!1,r.error=e.data.message})},300),r.branch=e.branch}function i(e){return e<=moment(r.max).endOf("day").toDate()&&e>=moment(r.min).startOf("day").toDate()}r.isLoading=!0,r.totals={},e.branch.name?o():e.$on("branchLoaded",function(){o()}),r.updateTotals=function(){var t;!r.loans||r.loans.length<=0||(t={count:0,loan:0,capital:0,interest:0,overdue:0,ticketReplacement:0,discount:0},r.loans.forEach(function(e){i(new Date(e.createdOn))&&(t.count++,t.loan+=e.amount,t.capital+=e.capitalPaid,t.interest+=e.interestPaid,t.capital+=e.overduePaid,t.capital+=e.ticketReplacement,t.capital+=e.discountAmount)}),console.log({totals:t}),r.totals=t)},r.filterBySelection=function(e){return i(moment(e.createdOn).startOf("day").toDate())},r.openMinPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMinPickerOpen=!r.isMinPickerOpen},r.openMaxPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMaxPickerOpen=!r.isMaxPickerOpen},r.print=function(){a.print()}}]),angular.module("BranchCtrl",["BranchService","ngFileUpload"]).controller("BranchController",["$scope","$window","$stateParams","tmhDynamicLocale","Upload","Branch","Page",function(a,t,e,n,r,o,i){function c(){a.user.isOwner&&o.getAll().then(function(e){a.branches=e.data.branches})}a.branch={id:e.branchId},o.get(e.branchId).then(function(e){a.branch=e.data.branch,t.localStorage.branchId=a.branch._id,n.set(e.data.branch.localeCode.toLowerCase()),a.$broadcast("branchLoaded"),a.$parent.branch=e.data.branch,a.branch.minutesToLock&&new Idle({onAway:function(){a.$parent.$broadcast("lockScreen")},awayTimeout:6e4*a.branch.minutesToLock}).start()}),a.isAuthenticated?c():a.$on("authChecked",c),a.revealMenu=function(){a.isSideMenuVisible=!a.isSideMenuVisible},a.uploadLogo=function(e){e=e[0];e&&(524288<e.size?alert("Tamaño máximo del archivo: 500KB"):r.upload({url:"/company/logo",file:e}).progress(function(e){}).success(function(e,t){heap.track("Uploaded logo"),a.company.hasLogo=!0,a.logoTimestamp=(new Date).getTime()}))}}]),angular.module("BranchSelectionCtrl",[]).controller("BranchSelectionController",["$scope","$state",function(e,t){var a=this;function n(){a.user=e.user,a.branches=e.branches,1===a.branches.length?t.go("branch.clients",{branchId:e.branches[0]._id}):a.isLoading=!1}a.isLoading=!0,e.isAuthenticated?n():e.$on("authChecked",function(){n()})}]),angular.module("BranchSettingsCtrl",["BranchService","MathUtilService"]).controller("BranchSettingsController",["$scope","$location","$uibModal","$analytics","toastr","Branch","Page","MathUtil",function(r,e,o,t,n,i,a,c){r.settings={},r.selected={},r.newUser={},a.section="branch-settings",r.isActive=[{active:!0},{active:!1},{active:!1}],r.selectedWeekdays=[],r.vm={};r.minutesToLockOptions=[{value:1,title:"1 minuto"},{value:5,title:"5 minutos"},{value:15,title:"15 minutos"},{value:30,title:"30 minutos"},{value:60,title:"1 hora"},{value:0,title:"Nunca"}];a=e.search().tab;function l(){i.getSettings(r.branch._id).then(function(e){r.settings=e.data.settings,s(),r.selectedWeekdays=[];for(var t=0;t<7;t++)r.selectedWeekdays.push({number:t,checked:-1<r.settings.nonWorkingDaysOfWeek.indexOf(t),name:moment.weekdays(t)});i.getIntl().then(function(e){r.timezones=e.data.intl.timezones,r.currencies=e.data.intl.currencies,r.localeCodes=e.data.intl.localeCodes})})}function s(){r.settings.categories.forEach(function(e){e.summary=i.getPeriodObjectFromPeriod(e.period,r.company.lang)})}a&&(r.selectedTabIndex={info:0,interest:1,operations:2,region:3,users:4,advanced:5}[a]),r.roundToDecimals=c.roundToDecimals,r.branch.name?l():r.$on("branchLoaded",function(){l()}),r.save=function(){r.settings.name&&i.saveSettings(r.branch._id,r.settings).then(function(e){n.success("Cambios guardados correctamente"),r.branch.ticketReplacementCost=r.settings.ticketReplacementCost||0})},r.test=function(){r.selected.category=null},r.addOrEditCategory=function(e){var t=!!e._id;o.open({templateUrl:"/views/_category.html",controller:"CategoryController",controllerAs:"vm",resolve:{data:function(){return{categoryId:e._id,branchId:r.branch._id}}}}).result.then(function(a){var n;t?(n=-1,r.settings.categories.forEach(function(e,t){e._id===a.categoryId&&(a.data?r.settings.categories[t]=a.data:n=t)}),0<=n&&r.settings.categories.splice(n,1)):r.settings.categories.push(a.data),s()},function(){})},r.addOrEditLayawayCategory=function(a){var n=!!a._id;o.open({templateUrl:"/views/_layawayCategory.html",controller:"LayawayCategoryController",controllerAs:"vm",resolve:{data:function(){return{category:a,branchId:r.branch._id,canRemove:1<r.settings.layawayCategories.length}}}}).result.then(function(e){var t;n?e.category||0<=(t=r.settings.layawayCategories.indexOf(a))&&r.settings.layawayCategories.splice(t,1):r.settings.layawayCategories.push(e.category)},function(){})},r.userTitles=[{name:"Empleado",code:2},{name:"Supervisor",code:4},{name:"Gerente",code:6}],r.positions={employee:2,supervisor:4,manager:6},r.addUser=function(){!r.company.isPilot&&!r.company.isSubscribed&&0<r.settings.users.length?o.open({templateUrl:"/views/_upgrade-modal.html",controller:"UpgradeModalController"}):(r.newUser={deviceSessionId:void 0},r.isCreatingUser=!0)},r.cancelCreatingUser=function(){r.isCreatingUser=!1,r.newUserError=""},r.dismissNewUserError=function(){r.newUserError=""},r.registerUser=function(){r.isRegisteringUser||(r.isRegisteringUser=!0,i.createUser(r.branch._id,r.newUser).then(function(e){r.settings.users.push(e.data.user),r.cancelCreatingUser(),r.isRegisteringUser=!1,heap.track("Add employee"),t.eventTrack("Add employee",{category:"Add employee"})}).catch(function(e){r.newUserError=e.data.message||e.data.description,r.isRegisteringUser=!1}))},r.removeUser=function(t){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar usuario",prompt:"¿Realmente quieres eliminar a "+t.name+"?\nEste usuario ya no podrá acceder a esta sucursal, a menos que vuelva a registrarse como empleado.\nAl eliminar a este usuario, las operaciones que haya realizado bajo su nombre seguirán mostrando su nombre."}}}}).result.then(function(e){e&&r.confirmRemoveUser(t)})},r.confirmRemoveUser=function(e){r.settings.users.splice(r.settings.users.indexOf(e),1),i.removeUser(r.branch._id,e._id).then(function(){heap.track("Remove employee"),t.eventTrack("Remove employee",{category:"Remove employee"}),n.success("El usuario fue eliminado")})},r.toggleUserAccess=function(e){e.isActive=!e.isActive},r.changePassword=function(t){o.open({templateUrl:"/views/_password-dialog.html",controller:"PasswordDialogController",resolve:{name:function(){return t.name}}}).result.then(function(e){i.changeUserPassword(r.branch._id,t._id,e).then(function(e){n.success("Contraseña modificada")})})},r.changeAccessHours=function(a){o.open({templateUrl:"/views/_access_hours.html",controller:"AccessHoursController",resolve:{accessHours:function(){return a.accessHours}}}).result.then(function(t){i.changeUserAccessHours(r.branch._id,a._id,t).then(function(e){a.accessHours=t,n.success("Horario modificado")})})},r.removeAllData=function(){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar datos de sucursal",prompt:"¿Quieres eliminar permanentemente todos los datos registrados en esta sucursal?\nSe perderá toda la información, incluyendo préstamos, clientes, ventas, flujo de caja, etc.\nNo se eliminarán los usuarios ni las configuraciones de intereses."}}}}).result.then(function(e){e&&i.removeAllData(r.branch._id).then(function(e){r.settings=e.data.branch,heap.track("Wipe branch data"),n.success("Todos los registros han sido eliminados.")}).catch(function(e){r.error=e.data.message||e.data.description})})},r.dismissError=function(){r.error=""},r.weekdays=moment.weekdays,r.weekdaySelected=function(){r.settings.nonWorkingDaysOfWeek=r.selectedWeekdays.filter(function(e){return e.checked}).map(function(e){return e.number})},r.openNonWorkingDayPicker=function(e){e.preventDefault(),e.stopPropagation(),r.vm.isNonWorkingDayPickerOpen=!0},r.addNonWorkingDayOfYear=function(){r.vm.nonWorkingDayToAdd&&!function(e,t){e=e.toISOString();return-1<t.indexOf(e)}(r.vm.nonWorkingDayToAdd,r.settings.nonWorkingDaysOfYear)&&r.settings.nonWorkingDaysOfYear.push(r.vm.nonWorkingDayToAdd.toISOString())},r.removeNonWorkingDayOfYear=function(e){e=r.settings.nonWorkingDaysOfYear.indexOf(e);-1<e&&r.settings.nonWorkingDaysOfYear.splice(e,1)}}]),angular.module("CashModalCtrl",[]).controller("CashModalController",["$scope","$uibModalInstance","template",function(e,t,a){e.template=a,e.cash=0,e.ok=function(){0<e.cash&&t.close({cash:e.cash,description:e.description})},e.cancel=t.dismiss}]),angular.module("CashflowCtrl",["BranchService","ConstantsService"]).controller("CashflowController",["$scope","$window","$filter","$timeout","$stateParams","Branch","Constants",function(e,t,a,n,s,r,o){var i=this;function c(){n(function(){var e=new Date;i.min=e,i.max=i.min},300),i.branch=e.branch,l()}function l(){r.getCashflow(i.branch._id,i.min,i.max).then(function(e){i.openingBalance=e.data.openingBalance,i.cashflow=e.data.cashflow,i.cashflow.forEach(function(e,t){var a="in"===e.flow?1:-1;e.balance=0===t?i.openingBalance+e.ammount*a:i.cashflow[t-1].balance+e.ammount*a}),0<i.cashflow.length?i.closingBalance=i.cashflow[i.cashflow.length-1].balance:i.closingBalance=i.openingBalance}).catch(function(e){i.error=e.data.message})}e.branch.name?c():e.$on("branchLoaded",function(){c()}),i.dismissError=function(){i.error=""},i.print=function(){t.print()},i.openMinPicker=function(e){e.preventDefault(),e.stopPropagation(),i.isMinPickerOpen=!i.isMinPickerOpen},i.openMaxPicker=function(e){e.preventDefault(),e.stopPropagation(),i.isMaxPickerOpen=!i.isMaxPickerOpen},i.descriptions=o.cashflowLog,i.descriptionList=Object.keys(i.descriptions),e.$watch("vm.min",function(e){e&&l()}),e.$watch("vm.max",function(e){e&&l()})}]),angular.module("CategoryCtrl",["BranchService","MathUtilService"]).controller("CategoryController",["$uibModalInstance","$uibModal","$filter","Branch","MathUtil","data",function(a,e,t,n,r,o){var i=this;i.category={},i.isLoading=!0,i.cancel=a.dismiss,i.isSaving=!1,i.roundToDecimals=r.roundToDecimals;o.categoryId?n.getCategory(o.branchId,o.categoryId).then(function(e){i.isLoading=!1,i.category=e.data.category}):(i.isLoading=!1,i.category={financeRate:.1,storageRate:0,vat:.16,isSalePriceFromAppraisal:!1,commercializationRate:.05,commercializationDays:0,minimumCharge:0,grace:5,anticipatedDays:0,anticipatedRate:.05,isOverdueFlatRate:!1,isOverdueDaily:!1,overdueRate:.02,period:"month",chargeFirstPeriod:!0,term:1,newContractAtRenewal:!0,keepChargingExpired:!1}),i.save=function(){!i.isSaving&&i.category.name&&(i.isSaving=!0,(i.category._id?n.editCategory(o.branchId,o.categoryId,i.category).then(function(e){heap.track("Edited Category"),a.close({categoryId:e.data.category._id,data:e.data.category})}):n.createCategory(o.branchId,i.category).then(function(e){heap.track("Created Category"),a.close({categoryId:e.data.category._id,data:e.data.category})})).finally(function(){i.isSaving=!1}))},i.removeCategory=function(t){e.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar categoría",prompt:"¿Confirmas eliminar la categoría "+t.name+"?"}}}}).result.then(function(e){e&&n.removeCategory(o.branchId,t._id).then(function(e){a.close({categoryId:o.categoryId,data:void 0})}).catch(function(e){i.error=e.data.message})})},i.getTotalRate=function(){return i.category.isStorageFlatRate?i.category.financeRate*(1+i.category.vat)*100+"% + "+t("currency")(i.category.storageRate*(1+i.category.vat)):(i.category.financeRate+i.category.storageRate)*(1+i.category.vat)*100+"%"}}]),angular.module("ClientCtrl",["ClientService"]).controller("ClientController",["$scope","$location","$uibModal","Client","Page",function(r,t,e,a,n){function o(){a.search(r.branch._id,r.query).then(function(e){r.clients=e.data.clients,r.totalPages=e.data.totalPages,r.page=parseInt(t.search().page)||1,r.isSearching=!!r.query.q,r.originalQuery=r.query.q})}n.section="client",r.query=t.search(),r.branch.name?o():r.$on("branchLoaded",function(){o()}),r.query.welcome&&e.open({templateUrl:"/views/_welcome.html",controller:"WelcomeController",controllerAs:"vm"}).result.then(function(){introJs().setOptions({showBullets:!1,showButtons:!1}).start()}),r.search=function(){delete r.query.page,r.query.q?t.search(r.query):t.search(""),o()},r.getPages=function(){var e=[],t=r.page,a=(t<1||r.totalPages<=5?t=1:r.page>=r.totalPages-5&&(t=r.totalPages-5),r.page+5);if(a>r.totalPages&&(a=r.totalPages),r.page)for(var n=t;n<=a;n++)e.push(n);return e},r.newClient=function(){heap.track("Click New Client"),t.path("/branch/"+r.branch._id+"/client/new").search({tour:!0})},r.goToPage=function(e){r.query.page=e,t.search(r.query),o()},r.goToNextPage=function(){r.page<r.totalPages&&r.goToPage(r.page+1)},r.goToPreviousPage=function(){1<r.page&&r.goToPage(r.page-1)}}]),angular.module("ClientDetailsCtrl",["ClientService"]).controller("ClientDetailsController",["$scope","$stateParams","$uibModal","Upload","Client","Page",function(a,t,e,n,r,o){o.section="client",a.client={},a.isLoadingPictures=!0,a.isLoadingDetails=!0,a.isCalculatingSummary=!0,a.rejectedFiles=[],a.summary={active:0,overdue:0,expireReady:0,expired:0,settled:0,cancelled:0};var i={active:{label:"Activo"},overdue:{label:"Vencido"},expireReady:{label:"Expiración pendiente"},expired:{label:"Expirado"},settled:{label:"Liquidado"},cancelled:{label:"Cancelado"}};function c(){r.getDetails(a.branch._id,t.clientId).then(function(e){a.client=e.data.client,a.client.picture="/branch/"+a.branch._id+"/client/"+a.client._id+"/picture?v="+(new Date).getTime(),r.pictures(a.branch._id,t.clientId).then(function(e){a.client.pictures=e.data.pictures,a.isLoadingPictures=!1}),a.client.loans.forEach(function(e){a.summary[e.status]=(a.summary[e.status]||0)+1});e=a.summary.expired+a.summary.settled;a.summary.rate=e<=0?100:Math.round(100*a.summary.settled/e),a.summary.status="warning",80<=a.summary.rate?a.summary.status="success":a.summary.rate<50&&2<a.summary.expired&&(a.summary.status="danger"),a.isCalculatingSummary=!1,a.isLoadingDetails=!1})}a.ItemStatus={forSale:"En venta",layaway:"Apartado",loan:"Empeñado",sold:"Vendido",settled:"Liquidado",cancelled:"Cancelado"},a.typesOfId={id:"Identificación oficial",license:"Licencia de conducir",passport:"Pasaporte"},a.branch.name?c():a.$on("branchLoaded",function(){c()}),a.dismissUploadError=function(){a.rejectedFiles=[]},a.dismissError=function(){a.error=""},a.getStatus=function(e){return i[e.status].label},a.uploadPicture=function(e){e.length&&n.upload({url:"/api/branch/"+a.branch._id+"/client/"+a.client._id+"/picture",file:e[0]}).progress(function(e){Math.round(100*e.loaded/e.total)}).success(function(e,t){a.client.pictures.push(e.picture)}).error(function(e){a.error=e.message})},a.capture=function(){e.open({templateUrl:"/views/_webcam.html",controller:"WebcamController",size:"lg",windowClass:"webcam-modal"}).result.then(function(e){r.uploadPicture(a.branch._id,a.client._id,e).then(function(e){a.client.pictures.push(e.data.picture)})})},a.deletePicture=function(t){e.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar foto",prompt:"¿Confirmas eliminar la fotografía permanentemente?"}}}}).result.then(function(e){e&&r.deletePicture(a.branch._id,a.client._id,t).then(function(e){a.client.pictures.splice(a.client.pictures.indexOf(t),1)})})},a.showUpgradePrompt=function(){e.open({templateUrl:"/views/_upgrade-modal.html",controller:"UpgradeModalController"})},a.toggleMenu=function(){a.isMenuVisible=!a.isMenuVisible}}]),angular.module("ClientEditOrCreateCtrl",["ClientService"]).controller("ClientEditOrCreateController",["$scope","$document","$timeout","$location","$stateParams","Client","Page",function(t,e,a,n,r,o,i){t.formData={},t.error="",t.autoCompleteResults=[],t.isSaving=!1,i.section="client";var c=!!r.clientId;function l(){c?(t.header={title:"Editar cliente",backUrl:"/branch/"+t.branch._id+"/client/"+r.clientId},o.getInfo(t.branch._id,r.clientId).then(function(e){t.formData=e.data.client,t.formData.birth=new Date(e.data.client.birth)})):t.header={title:"Nuevo cliente",backUrl:"/branch/"+t.branch._id+"/clients"}}t.branch.name?l():t.$on("branchLoaded",function(){l()}),t.typesOfId=[{id:"id",name:"Identificación oficial"},{id:"license",name:"Licencia de conducir"},{id:"passport",name:"Pasaporte"}],t.autoComplete=function(e){return o.autoComplete(t.branch._id,e).then(function(e){return e.data})},t.register=function(){var e;t.isSaving||(t.isSaving=!0,(e=t.formData).first&&e.last?c?o.update(t.branch._id,t.formData).then(function(e){t.isSaving=!1,heap.track("Edit client"),n.path("/branch/"+t.branch._id+"/client/"+e.data.clientId)}).catch(function(e){t.isSaving=!1,t.error=e.data}):o.create(t.branch._id,t.formData).then(function(e){t.isSaving=!1,heap.track("Create client"),n.path("/branch/"+t.branch._id+"/client/"+e.data.clientId)}).catch(function(e){t.isSaving=!1,heap.track("Error creating client",{error:e.data.message||e.data}),t.error=e.data}):(t.isSaving=!1,t.error="Campos requeridos"))},t.dismissError=function(){t.error=""},t.dateOptions={"show-weeks":!1,"show-button-bar":!1},t.openBirthPicker=function(e){e.preventDefault(),e.stopPropagation(),t.isBirthPickerOpen=!0},t.coOwnerBlur=function(){t.formData.coOwner||(t.formData.coOwner=null,t.hasCoOwnerNoResults=!1)}}]),angular.module("ClientReportCtrl",["ReportService"]).controller("ClientReportController",["$scope","$window","$location","$stateParams","Report",function(e,t,a,n,r){var o=this;function i(){o.branch=e.branch,c()}function c(){r.getClients(e.branch._id,n.reportType,a.search()).then(function(e){o.clients=e.data.clients,o.isLoading=!1})}o.clients=[],o.isLoading=!0,o.reportTitle=function(){switch(n.reportType){case"az":return"Clientes por orden alfabético";case"birth":return"Cumpleañeros del mes";case"score":return"Clientes por mejor puntuación";case"inactive":return"Clientes sin actividad reciente";default:return"Clientes"}}(),o.reportType=n.reportType,o.monthsAgo=parseInt(a.search().months),e.branch.name?i():e.$on("branchLoaded",function(){i()}),o.print=function(){t.print()},o.changeMonthsAgo=function(){a.search({months:o.monthsAgo}),o.isLoading=!0,c()},o.getIdTypeName=function(e){switch(e){case"id":return"Identificación oficial";case"license":return"Licencia de conducir";case"passport":return"Pasaporte";default:return""}}}]),angular.module("CompanyBillingCtrl",["UserService","CompanyService"]).controller("CompanyBillingController",["$scope","$window","$uibModal","User","Company",function(t,a,e,n,r){var o=this,i=t.companyVM;function c(e){r.updatePaymentMethod(e.id).then(function(e){a.location="/company/payment/success"})}o.isLoading=!0,i.active="billing",o.bills=[],r.getBilling().then(function(e){o.charges=e.data.charges,o.card=e.data.card,o.usage=e.data.usage,o.isLoading=!1},function(e){o.isLoading=!1,i.error=e.data.message}),o.deleteAccount=function(){e.open({templateUrl:"views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar mi cuenta",prompt:"Al eliminar tu cuenta se perderán permanentemente todos los datos referentes a tus sucursales, incluyendo préstamos, clientes, empleados, ventas, etc.\nTambién se cancelarán todas las suscripciones mensuales a tu tarjeta de crédito.\n¿Deseas continuar?"}}}}).result.then(function(e){n.deleteAccount().then(function(e){a.location.href="/"}).catch(function(e){o.error=e.data.message||e.data.description})})},o.updatePaymentMethod=function(){var e=t.company.isLive?"pk_live_uexcyoHHSMRQ46pLa4RzgGcL":"pk_test_d9cxx4itVxX3pNUTTx5PuECc";a.StripeCheckout.configure({key:e,image:"/img//icon.png",locale:t.company.language||"es",token:c,email:t.user.email,panelLabel:"en"===t.company.language?"Update":"Ingresar"}).open({name:"YoPresto",description:"Suscripción Pro",currency:t.user.currency,allowRememberMe:!1})}}]),angular.module("CompanyBranchesCtrl",["CompanyService","BranchService"]).controller("CompanyBranchesController",["$scope","$window","$uibModal","$analytics","Company","Branch",function(e,t,n,r,a,o){var i=this;e.companyVM.active="branches",i.error="",i.newBranch={},a.getBranches().then(function(e){i.list=e.data.branches}).catch(function(e){i.error=e.data.message}),i.addBranch=function(){e.company.isPilot||e.company.isSubscribed?i.isAddingNew=!0:n.open({templateUrl:"/views/_upgrade-modal.html",controller:"UpgradeModalController"})},i.createBranch=function(){i.newBranch.name&&(i.isCreating=!0,o.create(i.newBranch).then(function(e){heap.track("Add branch"),r.eventTrack("Add branch",{category:"Add branch"}),i.cancelAdd(),i.list.push(e.data.branch),i.isCreating=!1}).catch(function(e){heap.track("Error creating branch",{error:e.data.message||e.data}),i.error=e.data.message,i.isCreating=!1}))},i.cancelAdd=function(){i.newBranch={},i.isAddingNew=!1},i.delete=function(t,a){n.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar sucursal",prompt:"Todos los datos de esta sucursal se eliminarán, incluyendo préstamos, clientes, actividad de empleados y registros de caja.\n¿Confirmas eliminar esta sucursal?"}}}}).result.then(function(e){e&&(t.isRemoving=!0,o.remove(t._id).then(function(e){heap.track("Remove branch"),r.eventTrack("Remove branch",{category:"Remove branch"}),i.list.splice(a,1)}).catch(function(e){heap.track("Error deleting branch",{error:e.data.message||e.data}),i.error=e.data.message}))})},i.closeAlert=function(){i.error=""}}]),angular.module("CompanyCtrl",["CompanyService"]).controller("CompanyController",["$scope","Company",function(e,t){}]),angular.module("CompanyInfoCtrl",["CompanyService"]).controller("CompanyInfoController",["$scope","Company",function(e,t){var a=this;e.companyVM.active="info",a.error="",a.formData={},t.getInfo().then(function(e){a.formData=e.data.info}).catch(function(e){a.error=e.data.message}),a.save=function(){t.editInfo(a.formData).then(function(e){a.success="Guardado correctamente"}).catch(function(e){a.error=e.data.message})},a.closeErrorAlert=function(){a.error=""},a.closeSuccessAlert=function(){a.success=""}}]),angular.module("CompanyInvoicingCtrl",["CompanyService"]).controller("CompanyInvoicingController",["$scope","toastr","Company",function(e,t,a){var n=this,e=e.companyVM;n.isLoading=!0,e.active="invoicing",n.invoicing={},a.getInvoicingInfo().then(function(e){n.invoicing=e.data,n.isLoading=!1}).catch(function(e){n.isLoading=!1,n.error=e.data.message}),n.save=function(e){e.preventDefault(),n.error="",a.editInvoicingInfo(n.invoicing).then(function(e){t.success("Guardado correctamente")}).catch(function(e){n.error=e.data.message})},n.closeAlert=function(){n.error=""}}]),angular.module("CompanyTicketCtrl",[]).controller("CompanyTicketController",["$scope","$state",function(e,t){e.companyVM.active="ticket",this.goToEdit=function(){t.go("ticket-edit")}}]),angular.module("DashboardCtrl",["PageService","UserService","BranchService"]).controller("DashboardController",["$rootScope","$scope","$window","$cookies","$state","$analytics","$translate","$uibModal","Page","User","Branch",function(e,t,a,i,n,r,o,c,d,u,m){function l(){i.getObject("screenIsLocked")||(i.putObject("screenIsLocked",!0),s())}function s(){n.go("branch.locked",{branchId:a.localStorage.branchId})}t.Page=d,t.isSideMenuVisible=!1,u.info().then(function(e){t.isAuthenticated=!0,t.user=e.data.user,r.setUsername(e.data.user.email),heap.identify(e.data.user.email),heap.addUserProperties({isSubscribed:e.data.company.isSubscribed?"Yes":"No",name:e.data.user.name,email:e.data.user.email,company:e.data.company.name}),t.company=e.data.company,t.branches=e.data.branches,t.$broadcast("authChecked"),o.use(e.data.company.lang||"es"),moment.locale(e.data.company.lang||"es")}),t.lock=l,t.$on("lockScreen",l),e.$on("$stateChangeStart",function(e,t,a,n,r,o){i.getObject("screenIsLocked")&&"branch.locked"!==t.name&&(e.preventDefault(),s())}),t.toggleSideMenu=function(){t.isSideMenuVisible=!t.isSideMenuVisible},t.haveAQuestion=function(){c.open({templateUrl:"/views/_have-question.html",controller:"HaveQuestionController",controllerAs:"vm"})},t.closeTrialAlert=function(){t.hideTrialAlert=!0}}]),angular.module("DueSoonLoansReportCtrl",["ReportService"]).controller("DueSoonLoansReportController",["$scope","$window","Report",function(e,t,a){var n=this;function r(){n.branch=e.branch,i()}function o(){return moment().startOf("day").add(n.days,"days").toDate()}function i(){n.isLoading=!0,a.getDueSoonLoans(n.branch._id,n.until).then(function(e){var t;n.isLoading=!1,n.loans=e.data.loans,!n.loans||n.loans.length<=0||(t={count:0,loan:0,capital:0,interest:0,overdue:0,ticketReplacement:0,discount:0},n.loans.forEach(function(e){t.count++,t.loan+=e.amount,t.capital+=e.capitalPaid,t.interest+=e.interestPaid,t.capital+=e.overduePaid,t.capital+=e.ticketReplacement,t.capital+=e.discountAmount}),n.totals=t)}).catch(function(e){n.isLoading=!1,n.error=e.data.message})}n.today=new Date,n.isFiltered=!1,n.days=3,n.until=o(),n.isLoading=!0,e.branch.name?r():e.$on("branchLoaded",function(){r()}),n.changeDays=function(){n.until=o(),i()},n.print=function(){t.print()}}]),angular.module("DummyCtrl",[]).controller("DummyController",["$analytics",function(e){console.log("Registrando evento con angulartics..."),e.eventTrack("Evento con angulartics, yaay!",{category:"Evento con angulartics"}),console.log("Registrando evento con analytics..."),ga("send","event","Evento con analytics","Test","gaTest")}]),angular.module("ExpiredLoansReportCtrl",["ReportService"]).controller("ExpiredLoansReportController",["$scope","$window","Report",function(e,t,a){var n=this;function r(){n.branch=e.branch,o()}function o(){n.isLoading=!0,a.getExpiredLoans(n.branch._id,n.daysAgo||15).then(function(e){var t;n.isLoading=!1,n.loans=e.data.loans,!n.loans||n.loans.length<=0||(t={count:0,loan:0,capital:0,interest:0,overdue:0,ticketReplacement:0,discount:0},n.loans.forEach(function(e){t.count++,t.loan+=e.amount,t.capital+=e.capitalPaid,t.interest+=e.interestPaid,t.capital+=e.overduePaid,t.capital+=e.ticketReplacement,t.capital+=e.discountAmount}))}).catch(function(e){n.isLoading=!1,n.error=e.data.message})}n.today=new Date,n.isFiltered=!1,n.daysAgo=15,n.isLoading=!0,e.branch.name?r():e.$on("branchLoaded",function(){r()}),n.changeDaysAgo=function(){o()},n.print=function(){t.print()}}]),angular.module("ForgotCtrl",["UserService"]).controller("ForgotController",["$scope","User",function(t,e){t.alerts=[],t.sendEmail=function(){t.email?e.sendRecoveryEmail(t.email).then(function(e){t.isEmailSent=!0}).catch(function(e){t.alerts.push(e.data)}):t.alerts.push({message:"Ingresa el correo electrónico con el que te inscribiste."})},t.closeAlert=function(e){t.alerts.splice(e,1)}}]),angular.module("HaveQuestionCtrl",["paragraphsToArrayFilter"]).controller("HaveQuestionController",["$uibModalInstance",function(e){this.cancel=e.dismiss,heap.track("Clicked I Have a Question")}]),angular.module("HomeCtrl",["HomeService"]).controller("HomeController",["$scope","$location","$uibModal","$translate","Page","Home",function(t,e,a,n,r,o){t.Page=r,t.contactForm={},r.name="home",t.$parent.seo={pageTitle:t.Page.title,pageDescription:"Administra tu negocio de préstamos en la nube. Amortizaciones automáticas. Notificaciones. Compatible con Móviles. Empieza gratis."},t.playVideo=function(){a.open({size:"lg",templateUrl:"views/_videoLandingModal.html",controller:"VideoLandingModalController"}).result.then(function(){e.path("/register")})},t.contact=function(){var e=t.contactForm;e.name&&e.email&&e.message&&(t.isSendingMessage||(t.isSendingMessage=!0,o.sendMessage(t.contactForm).then(function(e){t.isSendingMessage=!1,t.messageSent=!0,heap.track("Submit Contact Form")}).catch(function(){t.isSendingMessage=!1})))}}]),angular.module("InventoryCtrl",["ItemService"]).controller("InventoryController",["$scope","$location","$state","Item",function(r,t,e,a){var n,o;function i(){a.search(r.branch._id,r.query).then(function(e){r.items=e.data.items,r.totalPages=e.data.totalPages,r.page=parseInt(t.search().page)||1,r.isSearching=!!r.query,r.location=t.path(),r.originalQuery=r.query})}"branch.inventory"===e.current.name?(n="forSale",o="allInventory",r.Page.section="inventory"):(n="sold",o="allHistory",r.Page.section="history"),r.query=t.search(),r.query.status=r.query.status||n,r.isStatusSearchActive=!1,r.STATUS_PLURAL={forSale:"en venta",layaway:"apartadas",loan:"empeñadas",sold:"vendidas",settled:"liquidadas",cancelled:"canceladas",melted:"fundidas",all:"todas"},r.STATUS={forSale:"En venta",layaway:"Apartado",loan:"Empeñado",sold:"Vendido",melted:"Fundido",settled:"Liquidado",cancelled:"Cancelado"},r.branch.name?i():r.$on("branchLoaded",function(){i()}),r.search=function(){r.query.page=1,r.query.q?(r.isSearchStatusActive||(r.query.status=o),t.search(r.query)):(t.search(""),r.query.status===o&&(r.query.status=n)),i()},r.searchStatus=function(e){r.query={status:e},i()},r.toggleSearchStatusActive=function(){r.isSearchStatusActive=!r.isSearchStatusActive},r.getPages=function(){var e=[],t=r.page,a=(t<1||r.totalPages<=5?t=1:r.page>=r.totalPages-5&&(t=r.totalPages-5),r.page+5);if(a>r.totalPages&&(a=r.totalPages),r.page)for(var n=t;n<=a;n++)e.push(n);return e},r.goToPage=function(e){r.query.page=e,t.search(r.query),i()},r.goToNextPage=function(){r.page<r.totalPages&&r.goToPage(r.page+1)},r.goToPreviousPage=function(){1<r.page&&r.goToPage(r.page-1)}}]),angular.module("InventoryReportCtrl",["ReportService"]).controller("InventoryReportController",["$scope","$window","$stateParams","Report",function(e,t,a,n){var r=this,o=a.status,i=a.type;switch(r.type=i,o){case"loan":r.reportTitle="Prendas empeñadas";break;case"forsale":r.reportTitle="Prendas en venta";break;case"layaway":r.reportTitle="Prendas apartadas"}if(i)switch(i){case"jewl":r.reportTitle=r.reportTitle+" (joyas)";break;case"vehicle":r.reportTitle=r.reportTitle+" (vehículos)";break;case"object":r.reportTitle=r.reportTitle+" (artículos)"}function c(){r.branch=e.branch,r.isLoading=!0,n.getInventory(e.branch._id,o,i).then(function(e){r.isLoading=!1,r.items=e.data.items,r.purchaseTotal=0,r.priceTotal=0,r.items.forEach(function(e){r.purchaseTotal+=e.cost,r.priceTotal+=e.price},0)},function(e){r.isLoading=!1,r.error=e.data.message})}r.orderField="layaway"===o?"layaway.createdAt":"createdOn",e.branch.name?c():e.$on("branchLoaded",function(){c()}),r.dismissError=function(){r.error=""},r.print=function(){t.print()}}]),angular.module("ItemDetailsCtrl",["ItemService"]).controller("ItemDetailsController",["$scope","$location","$stateParams","$uibModal","toastr","Upload","Item",function(a,t,n,e,r,o,i){function c(){i.getDetails(a.branch._id,n.itemId).then(function(e){a.item=e.data.item,a.isLoadingDetails=!1;e=a.item;"loan"===e.status||"forSale"===e.status||"layaway"===e.status?a.backPage="inventory":a.backPage="history",a.Page.section=a.backPage,l(),i.pictures(a.branch._id,n.itemId).then(function(e){a.item.pictures=e.data.pictures,a.isLoadingPictures=!1}).catch(function(e){a.error=e.data.message,a.isLoadingPictures=!1})})}function l(){var e=a.item;e.layaway.payments.length&&(e.layaway.balance=e.layaway.payments.reduce(function(e,t){return t.balance=e-t.amount,t.balance},e.price))}a.Page.section="inventory",a.isLoadingPictures=!0,a.isLoadingDetails=!0,a.rejectedFiles=[],a.error="",a.uploadError="",a.STATUS={loan:"Empeñado",forSale:"En venta",layaway:"Apartado",sold:"Vendido",cancelado:"Cancelado",settled:"Liquidado",melted:"Fundido"},a.branch.name?c():a.$on("branchLoaded",function(){c()}),a.dismissError=function(){a.error=""},a.dismissUploadError=function(){a.uploadError=""},a.dismissRejectedFiles=function(){a.rejectedFiles=[]},a.uploadPicture=function(e){e.length&&o.upload({url:"/api/branch/"+a.branch._id+"/item/"+a.item._id+"/picture",file:e[0]}).progress(function(e){Math.floor(100*e.loaded/e.total)}).success(function(e,t){a.item.pictures.push(e.picture)}).error(function(e){a.uploadError=e.message})},a.capture=function(){e.open({templateUrl:"/views/_webcam.html",controller:"WebcamController",size:"lg",windowClass:"webcam-modal"}).result.then(function(e){i.uploadPicture(a.branch._id,a.item._id,e).then(function(e){a.item.pictures.push(e.data.picture)})})},a.deletePicture=function(t){e.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar foto",prompt:"¿Confirmas eliminar la fotografía permanentemente?"}}}}).result.then(function(e){e&&i.deletePicture(a.branch._id,a.item._id,t).then(function(e){a.item.pictures.splice(a.item.pictures.indexOf(t),1)})})},a.sell=function(){e.open({templateUrl:"/views/_item-sell-modal.html",controller:"ItemSellModalController",resolve:{template:function(){return{item:a.item,branchId:a.branch._id,isLayaway:!1}}}}).result.then(function(e){i.sell(a.branch._id,a.item._id,e.client._id).then(function(e){heap.track("Sell item"),r.success("Prenda vendida"),a.item=e.data.item}).catch(function(e){heap.track("Error selling item",{error:e.data.message||e.data}),r.error(e.data.message||e.data)})})},a.layAway=function(){e.open({templateUrl:"/views/_item-sell-modal.html",controller:"ItemSellModalController",resolve:{template:function(){return{item:a.item,branchId:a.branch._id,advancePercentage:a.branch.layawayAdvancePercentage,isLayaway:!0}}}}).result.then(function(e){i.layAway(a.branch._id,a.item._id,e.client._id,e.amount,e.layawayCategory).then(function(e){heap.track("Sell item"),e.data.wasSold?r.success("La prenda fue vendida por haber cubierto el monto total"):r.success("Prenda apartada"),a.item=e.data.item,l()}).catch(function(e){heap.track("Error selling item",{error:e.data.message||e.data}),r.error(e.data.message||e.data)})})},a.creditLayaway=function(){e.open({templateUrl:"/views/_payment.html",controller:"PaymentController",resolve:{template:function(){return{title:"Registrar pago",fixedPayment:0,remainder:a.item.layaway.balance,remainderLabel:"Restante",showAdditional:!0,additionalLabel:"Pago",action:"Pagar"}}}}).result.then(function(e){i.creditLayaway(a.branch._id,a.item._id,e.payment).then(function(e){heap.track("Sell item"),e.data.wasSold?r.success("La prenda fue vendida por haber cubierto el monto total"):r.success("Pago registrado"),a.item=e.data.item,l()}).catch(function(e){heap.track("Error selling item",{error:e.data.message||e.data}),r.error(e.data.message||e.data)})})},a.expireLayaway=function(){e.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Marcar apartado como expirado",prompt:"¿Confirmas expirar el apartado y poner la prenda en venta?"}}}}).result.then(function(e){e&&i.expireLayaway(a.branch._id,a.item._id).then(function(e){a.item=e.data.item,r.success("Apartado expirado")}).catch(function(e){a.error=e.data.message})})},a.cancelPurchase=function(){e.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Cancelar compra de prenda",prompt:"¿Confirmas eliminar la prenda permanentemente y cancelar la compra?"}}}}).result.then(function(e){e&&i.cancelPurchase(a.branch._id,a.item._id).then(function(e){t.path("/branch/"+a.branch._id+"/inventory")}).catch(function(e){a.error=e.data.message})})},a.cancelSale=function(){e.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Cancelar venta de prenda",prompt:"¿Confirmas cancelar la venta y poner la prenda en venta?"}}}}).result.then(function(e){e&&i.cancelSale(a.branch._id,a.item._id).then(function(e){a.item=e.data.item,r.success("Venta cancelada")}).catch(function(e){a.error=e.data.message})})},a.melt=function(){e.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Fundir prenda",prompt:"¿Confirmas fundir la prenda y agregarla a tu inventario de metales?"}}}}).result.then(function(e){e&&i.melt(a.branch._id,a.item._id).then(function(e){heap.track("Melt item"),r.success("Prenda fundida"),a.item=e.data.item}).catch(function(e){a.error=e.data.message})})}}]),angular.module("ItemEditCtrl",["ItemService"]).controller("ItemEditController",["$scope","$state","$stateParams","Item",function(t,a,n,e){function r(){e.getDetails(t.branch._id,n.itemId).then(function(e){t.itemData=e.data.item})}t.itemData={},t.branch.name?r():t.$on("branchLoaded",function(){r()}),t.save=function(){e.edit(t.branch._id,n.itemId,t.itemData).then(function(e){a.go("branch.item",{branchId:t.branch._id,itemId:n.itemId})}).catch(function(e){t.error=e.data.message})}}]),angular.module("ItemSellModalCtrl",["ClientService","BranchService"]).controller("ItemSellModalController",["$scope","$uibModalInstance","template","Client","Branch",function(a,e,n,t,r){a.item=n.item,a.template=n,a.form={},a.title=n.isLayaway?"Apartar prenda":"Vender prenda",a.label=n.isLayaway?"Apartar con":"Precio de venta",a.action=n.isLayaway?"Apartar":"Vender",n.isLayaway?r.getLayawayCategories(n.branchId).then(function(e){a.layawayCategories=e.data.layawayCategories,a.form.layawayCategory=a.layawayCategories[0]._id,a.onCategoryChange()}).catch(console.log):a.form.amount=n.item.price,a.ok=function(){a.form.client?!n.isLayaway||a.form.layawayCategory?e.close(a.form):a.error="Selecciona una categoría":a.error="Escribe un nombre en el campo de texto para seleccionar un cliente"},a.calculateRemainder=function(){return n.item.price-a.form.amount},a.dismissError=function(){a.error=""},a.autoComplete=function(e){return a.isLoadingClients=!0,t.autoComplete(n.branchId,e).then(function(e){return a.isLoadingClients=!1,e.data})},a.onCategoryChange=function(){var e,t;!a.form.layawayCategory||(e=a.layawayCategories.filter(function(e){return e._id===a.form.layawayCategory})[0])&&(t=n.item.price*e.advancePercentage,a.form.amount=t,a.minimum=e.allowLessAdvance?0:t)},a.cancel=e.dismiss}]),angular.module("LayawayCategoryCtrl",["BranchService","MathUtilService"]).controller("LayawayCategoryController",["$uibModalInstance","$uibModal","Branch","data",function(a,e,n,r){var o=this;o.category={},o.cancel=a.dismiss,o.isSaving=!1,o.canRemove=!!r.canRemove;r.category._id?o.category=r.category:o.category={name:"Nueva categoría",limitDays:30,advancePercentage:.2,allowLessAdvance:!1},o.save=function(){!o.isSaving&&o.category.name&&(o.isSaving=!0,(o.category._id?n.editLayawayCategory(r.branchId,r.category).then(function(e){heap.track("Edited Layaway Category"),a.close({category:e.data.category})}):n.createLayawayCategory(r.branchId,o.category).then(function(e){heap.track("Created Layaway Category"),a.close({category:e.data.category})})).finally(function(){o.isSaving=!1}))},o.removeCategory=function(t){e.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar categoría",prompt:"¿Confirmas eliminar la categoría "+t.name+"?"}}}}).result.then(function(e){e&&n.removeLayawayCategory(r.branchId,t._id).then(function(e){a.close({category:void 0})}).catch(function(e){o.error=e.data.message})})}}]),angular.module("LayawayReceiptCtrl",["ItemService","ReportService"]).controller("LayawayReceiptController",["$scope","$stateParams","Item","Report",function(t,e,a,n){var r=this;function o(){a.getDetails(e.branchId,e.itemId).then(function(e){var a;r.item=e.data.item,(a=r.item).layaway.payments.length&&(a.layaway.paid=0,a.layaway.balance=a.layaway.payments.reduce(function(e,t){return t.balance=e-t.amount,a.layaway.paid+=t.amount,t.balance},a.price))}).catch(function(e){e.data&&(t.$parent.error=e.data.message)}),n.getLayawayReceiptSettings(e.branchId).then(function(e){t.$parent.template.header=e.data.settings.header,t.$parent.template.footer=e.data.settings.footer})}r.branchId=e.branchId,r.itemId=e.itemId,t.$parent.template={title:"Recibo de apartado",backUrl:"/branch/"+r.branchId+"/item/"+r.itemId},t.branch&&t.branch.name?o():t.$on("branchLoaded",function(){o()})}]),angular.module("LoanBalanceCtrl",["LoanService","ReportService","MathUtilService","ConstantsService"]).controller("LoanBalanceController",["$scope","$stateParams","MathUtil","Loan","Report","Constants",function(t,e,a,n,r,o){var i=this;function c(){n.getDetails(e.branchId,e.loanId).then(function(e){i.loan=e.data.details,i.loan.paid=i.loan.operations.reduce(function(e,t){return e+t.credit},0);var n=[],r=1;i.loan.operations.forEach(function(e,t){e.concept=i.LOG[e.log];var a=n[n.length-1];a&&1===a.log&&a.log===e.log?(a.charge+=e.charge,a.balance=e.balance,a.date=e.date,a.concept=(++r).toString()+" x "+i.LOG[e.log]):(r=1,n.push(e))}),i.loan.operations=n}).catch(function(e){e.data&&(t.$parent.error=e.data.message)}),r.getLoanPaymentReceiptSettings(e.branchId).then(function(e){t.$parent.template.header=e.data.settings.header,t.$parent.template.footer=e.data.settings.footer})}i.PERIOD=o.loanPeriod,i.PLURALIZED_PERIOD=o.loanPluralizedPeriod,i.SINGULAR_PERIOD=o.loanSingularPeriod,i.LOG=o.loanLog,i.template={title:"Estado de cuenta de préstamo",backUrl:"/branch/"+e.branchId+"/loan/"+e.loanId},t.$parent.template=i.template,t.branch&&t.branch.name?c():t.$on("branchLoaded",function(){c()}),i.getStockNumbers=function(){if(i.loan)return i.loan.items.reduce(function(e,t){t=t.stockNumber;return e?", "+t:t},"")},i.round=a.roundToDecimals}]),angular.module("LoanCtrl",["ConstantsService"]).controller("LoanController",["$scope","$location","Loan","Constants",function(r,t,e,a){function n(){e.search(r.branch._id,r.query).then(function(e){r.loans=e.data.loans,r.totalPages=e.data.totalPages,r.page=parseInt(t.search().page,10)||1,r.isSearching=!!r.query.q,r.originalQuery=r.query.q})}r.query=t.search(),r.query.status=r.query.status||"active",r.isStatusSearchActive=!1,r.Page.section="loan",r.STATUS_PLURAL=a.loanStatusPlural,r.STATUS=a.loanStatus,r.branch.name?n():r.$on("branchLoaded",function(){n()}),r.search=function(){delete r.query.page,r.query.q?(r.isSearchStatusActive||(r.query.status="all"),t.search(r.query)):(t.search(""),"all"===r.query.status&&(r.query.status="active")),n()},r.searchStatus=function(e){r.query={status:e},n()},r.toggleSearchStatusActive=function(){r.isSearchStatusActive=!r.isSearchStatusActive},r.getPages=function(){var e=[],t=r.page,a=(t<1||r.totalPages<=5?t=1:r.page>=r.totalPages-5&&(t=r.totalPages-5),r.page+5);if(a>r.totalPages&&(a=r.totalPages),r.page)for(var n=t;n<=a;n++)e.push(n);return e},r.goToPage=function(e){r.query.page=e,t.search(r.query),n()},r.goToNextPage=function(){r.page<r.totalPages&&r.goToPage(r.page+1)},r.goToPreviousPage=function(){1<r.page&&r.goToPage(r.page-1)}}]),angular.module("LoanCreateCtrl",["angularMoment","LoanService","ClientService","BranchService","MathUtilService","ConstantsService"]).controller("LoanCreateController",["$scope","$location","$document","$stateParams","$analytics","$translate","moment","Page","Loan","Client","Branch","Item","MathUtil","Constants",function(n,a,r,e,o,d,i,u,m,p,c,l,h,g){n.loan={},n.datePickerSettings={},n.items=[{}],n.error="",n.autoCompleteResults=[],n.isSaving=!1,u.section="loan";var f={day:{period:"days",coeficient:1},week:{period:"weeks",coeficient:1},fort:{period:"days",coeficient:15},month:{period:"months",coeficient:1},"30-day":{period:"days",coeficient:30}};function t(){p.getInfo(n.branch._id,e.clientId).then(function(e){n.client=e.data.client,n.header={title:"Nuevo préstamo",backUrl:"/branch/"+n.branch._id+"/client/"+n.client._id},n.loan.createdOn=new Date}),c.getCategories(n.branch._id).then(function(e){n.categories=e.data.categories}),c.getSettings(n.branch._id).then(function(e){n.branchSettings=e.data.settings,n.allowedPurityGold=Object.keys(e.data.settings.allowedPurity.gold).map(function(e){return parseInt(e)}),n.allowedPuritySilver=Object.keys(e.data.settings.allowedPurity.silver).map(function(e){return parseInt(e)})})}function s(){return n.items.reduce(function(e,t){return{lent:(e.lent||0)+(t.lent||0)}},{lent:0}).lent||0}n.weightUnitNames=g.weightUnitNames,n.branch.name?t():n.$on("branchLoaded",function(){t()}),n.save=function(){var e,t;n.isSaving||(n.isSaving=!0,e=n.loan,(t=n.items.map(function(e){return l.parse(e,n.branch)})).length&&e.category?m.create(n.branch._id,n.client._id,e,t).then(function(e){heap.track("Create loan"),a.path("/branch/"+n.branch._id+"/loan/"+e.data.loan._id),n.isSaving=!1,o.eventTrack("Create loan",{category:"Create loan"})},function(e){e=e.err;n.hasReachedLimit=e.hasReachedLimit,n.error=e.message,r.scrollTo(0,0,500),n.isSaving=!1,heap.track("Error creating loan",{error:e.message||e})}):(n.isSaving=!1,n.error="Campos requeridos"))},n.openDatePicker=function(e){e.preventDefault(),e.stopPropagation(),n.datePickerSettings.isDatePickerOpen=!0},n.dismissError=function(){n.error=""},n.roundToDecimals=h.roundToDecimals,n.categoryChanged=function(){t=n.loan.category;var t,e,a=n.categories.filter(function(e){return e._id===t})[0];a?(e=f[a.period],n.summary={rate:a.rate,storageFlatRate:a.isStorageFlatRate?a.storageRate*(1+a.vat):0,term:a.term,period:c.getPeriodObjectFromPeriod(a.period,n.company.lang),ends:i(n.loan.createdOn).add(a.term*e.coeficient,e.period).toDate()}):n.summary={}},n.addItem=function(){n.items.push({})},n.removeItem=function(e){n.items.splice(n.items.indexOf(e),1)},n.getTotalLoan=function(){return s()},n.getTotalInterest=function(){var e=0;return n.summary&&(e=s()*(n.summary.rate||0)*(n.summary.term||0),e+=n.summary.storageFlatRate*(n.summary.term||0)),e},n.getTotalPayment=function(){var e=s();return e=n.summary?(e*=1+(n.summary.rate||0)*(n.summary.term||0))+n.summary.storageFlatRate*(n.summary.term||0):e},n.getAppraisal=function(a){l.getAppraisal(a,n.branch.currency,n.branchSettings,function(e,t){e?n.error=e.message:a.appraisal=parseFloat(t.toFixed(2))})}}]),angular.module("LoanDetailsCtrl",["LoanService","MathUtilService","ConstantsService"]).controller("LoanDetailsController",["$scope","$stateParams","$location","$uibModal","toastr","Loan","Page","MathUtil","Constants",function(r,e,t,o,i,c,a,d,n){a.section="loan",r.loan={},r.isMenuVisible=!1,r.isLoadingDetails=!0,r.STATUS=n.loanStatus,r.PERIOD=n.loanPeriod,r.PLURALIZED_PERIOD=n.loanPluralizedPeriod,r.SINGULAR_PERIOD=n.loanSingularPeriod,r.LOG=n.loanLog;var l={RENEWAL:2,CREDITED:3,PAID_OVERDUE:6,DISCOUNT:7};function s(){c.getDetails(r.branch._id,e.loanId).then(function(e){r.loan=e.data.details,r.isActive="active"===r.loan.status||"overdue"===r.loan.status||"expireReady"===r.loan.status,r.isLoadingDetails=!1})}r.LogCode=l,r.branch.name?s():r.$on("branchLoaded",function(){s()}),r.toggleMenu=function(){r.isMenuVisible=!r.isMenuVisible},r.pay=function(e,t,a,n){r.isMenuVisible=!1,o.open({templateUrl:"/views/_payment.html",controller:"PaymentController",resolve:{template:function(){return{title:"Registrar pago",fixedPayment:t,isFixedEditable:!!n&&r.loan.category.partialPayments,ticketReplacementCost:t>=r.loan.pending.settle?r.branch.ticketReplacementCost:0,showAdditional:a||!1,additionalLabel:"Abono a capital",action:"Pagar",fixedPaymentLabel:e}}}}).result.then(function(e){c.pay(r.branch._id,r.loan._id,e.payment,e.ticketReplacement).then(function(e){i.success("Pago registrado"),heap.track("Pago registrado"),r.loan=e.data.details,r.isActive="active"===r.loan.status})})},r.discount=function(){r.isMenuVisible=!1,o.open({templateUrl:"/views/_payment.html",controller:"PaymentController",resolve:{template:function(){return{title:"Aplicar descuento",fixedPayment:0,showAdditional:!0,action:"Aplicar",additionalLabel:"Descuento"}}}}).result.then(function(e){c.discount(r.branch._id,r.loan._id,e.payment).then(function(e){i.success("Descuento aplicado"),heap.track("Descuento aplicado"),r.loan=e.data.details})})},r.cancel=function(){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Cancelar préstamo",prompt:"El préstamo se marcará como cancelado. Los registros de caja y las prendas asociadas se eliminarán permanentemente.\n¿Deseas continuar?"}}}}).result.then(function(e){c.cancel(r.branch._id,r.loan._id).then(function(e){i.success("Préstamo cancelado"),r.isActive=!1,r.loan=e.data.details})})},r.undoSettle=function(){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Revertir liquidación",prompt:"El préstamo, las prendas asociadas y los registros de caja volverán al estado que tenían antes de liquidar el préstamo.\n¿Deseas continuar?"}}}}).result.then(function(e){c.undoSettle(r.branch._id,r.loan._id).then(function(e){i.success("Liquidación revertida exitosamente"),r.isActive=!0,r.loan=e.data.details})})},r.undoDiscount=function(t){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Revertir descuento",prompt:"Este descuento será eliminado.\n¿Deseas continuar?"}}}}).result.then(function(e){c.undoDiscount({branchId:r.branch._id,loanId:r.loan._id,createdOn:t}).then(function(e){i.success("Descuento revertido exitosamente"),r.loan=e.data.details}).catch(function(e){i.error(e.data.message),r.loan=e.data.details})})},r.recalcEndDate=function(e){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Recalcular fecha de vencimiento",prompt:"La fecha de vencimiento cambiará de ser necesario.\n¿Deseas continuar?"}}}}).result.then(function(e){c.recalcEndDate(r.branch._id,r.loan._id).then(function(e){i.success("Fecha de vencimiento actualizada"),r.loan=e.data.details}).catch(function(e){i.error(e.data.message),r.loan=e.data.details})})},r.isPayment=function(e){return[l.RENEWAL,l.CREDITED,l.PAID_OVERDUE].includes(e)},r.undoPayment=function(t){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Revertir pago",prompt:"Este pago será eliminado.\n¿Deseas continuar?"}}}}).result.then(function(e){c.undoPayment({branchId:r.branch._id,loanId:r.loan._id,createdOn:t}).then(function(e){i.success("Pago revertido exitosamente"),r.loan=e.data.details}).catch(function(e){i.error(e.data.message),r.loan=e.data.details})})},r.expire=function(){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Marcar préstamo expirado",prompt:"El préstamo se marcará como expirado y las prendas pasarán a venta.\n¿Deseas continuar?"}}}}).result.then(function(e){c.expire(r.branch._id,r.loan._id).then(function(e){i.success("Préstamo marcado como expirado"),r.isActive=!1,r.loan=e.data.details})})},r.delete=function(){o.open({templateUrl:"/views/_yes-no.html",controller:"YesNoController",resolve:{template:function(){return{title:"Eliminar préstamo",prompt:"El préstamo se eliminará permanentemente.\n¿Deseas continuar?"}}}}).result.then(function(e){c.delete(r.branch._id,r.loan._id).then(function(e){t.url("/branch/"+r.branch._id+"/client/"+r.loan.client._id)})})},r.round=d.roundToDecimals}]),angular.module("LoanPaymentReceiptCtrl",["LoanService","ConstantsService"]).controller("LoanPaymentReceiptController",["$scope","$stateParams","Loan","Report","Constants",function(t,e,a,n,r){var o=this;function i(){a.getDetails(e.branchId,e.loanId).then(function(e){o.loan=e.data.details,o.paid=0,o.operations=o.loan.operations.filter(function(e){return 0<e.credit}).filter(function(e,t,a){return e.date===a[a.length-1].date}),o.operations.forEach(function(e){o.paid+=e.credit})}).catch(function(e){e.data&&(t.$parent.error=e.data.message)}),n.getLoanPaymentReceiptSettings(e.branchId).then(function(e){t.$parent.template.header=e.data.settings.header,t.$parent.template.footer=e.data.settings.footer})}o.branchId=e.branchId,o.loanId=e.loanId,o.template={title:"Recibo de pago a préstamo",backUrl:"/branch/"+o.branchId+"/loan/"+o.loanId},t.$parent.template=o.template,o.LOG=r.loanLog,t.branch&&t.branch.name?i():t.$on("branchLoaded",function(){i()})}]),angular.module("LockCtrl",["UserService","BranchService","ConstantsService"]).controller("LockController",["$scope","$window","$cookies","$stateParams","User","Branch","Constants",function(t,a,n,e,r,o,i){var c=this;c.formData={},c.errorMessage="",n.putObject("screenIsLocked",!0),o.getUsers(e.branchId).then(function(e){c.users=e.data.users,c.formData.email=c.users.find(function(e){return e.email===t.user.email}).email}),c.formChange=function(){c.errorMessage=""},c.logIn=function(){r.login(c.formData).then(function(e){e.data.success?(heap.track("Renew session"),n.putObject("screenIsLocked",!1),a.location="/"):c.errorMessage=e.data.message}).catch(function(e){e.data.loginStatus?c.errorMessage=i.LoginStatus[e.data.loginStatus].message:401===e.status?c.errorMessage=i.LoginStatus[0].message:c.errorMessage=e.data.message})}}]),angular.module("LoginCtrl",["UserService"]).controller("LoginController",["$scope","$window","$cookies","$translate","User","Page",function(a,t,n,e,r,o){var i,c;(a.Page=o).title="Login",o.name="login",i="es"===e.use()?{0:{message:"Correo o contraseña incorrectos"},1:{message:"Fuera del horario de trabajo"},2:{message:"Cuenta inactiva"},3:{message:"Cuenta eliminada. Contacte a soporte@yopresto.com para restablecer el acceso."},4:{message:"No has verificado tu correo electrónico."}}:{0:{message:"Incorrect email or password"},1:{message:"Outside working hours"},2:{message:"Account inactive"},3:{message:"Account deleted. Please contact welcome@yopresto.com to restore access."},4:{message:"You haven not verified your email. Please follow the link we sent to you."}},a.$parent.isAuthenticated?t.location="/":(a.formData={},a.errorMessage="",c="es"===e.use()?"Correo o contraseña incorrectos":"Incorrect email or password",a.login=function(){r.login(a.formData).then(function(e){e.data.success?(n.putObject("screenIsLocked",!1),heap.track("Log in"),t.location="/"):a.errorMessage=e.data.message}).catch(function(e){console.log({error:e});var t=e.data.loginStatus;t?(4===t&&(a.isNotVerified=!0),a.errorMessage=i[e.data.loginStatus].message):401===e.status?a.errorMessage=c:a.errorMessage=e.data.message})},a.formChange=function(){a.errorMessage=""},a.resend=function(){a.formData.email&&(r.resend(a.formData.email),a.hasResentVerification=!0)})}]),angular.module("MainCtrl",["PageService"]).controller("MainController",["$scope","$location","$translate","Page","User",function(t,a,n,e,r){t.Page=e,t.year=(new Date).getFullYear(),r.info().then(function(e){e.success&&(t.isAuthenticated=!0,t.user=e.data.user,heap.identify(e.data.user.email),heap.addUserProperties({isSubscribed:e.data.user.company.isSubscribed?"Yes":"No",name:e.data.user.name,email:e.data.user.email,company:e.data.user.company.name}),t.company=e.data.company,t.branches=e.data.branches,t.$broadcast("authChecked"),e.data.company.language&&n.use(e.data.company.language))}),t.toggleLanguage=function(){var e=a.path();"en"===n.use()?(n.use("es"),a.path(e.replace(/^\/en/,"/es"))):(n.use("en"),a.path(e.replace(/^\/es/,"/en")))}}]),angular.module("MeltedReportCtrl",["ReportService"]).controller("MeltedReportController",["$scope","$window","$timeout","Report",function(e,t,a,n){var r=this;function o(){a(function(){var e=new Date;r.min=moment().subtract(1,"month").toDate(),r.max=e},300),r.branch=e.branch,i()}function i(){r.min&&r.max&&(r.isLoading=!0,n.getMelted(e.branch._id,moment(r.min).startOf("day").toDate(),moment(r.max).endOf("day").toDate()).then(function(e){r.isLoading=!1,r.items=e.data.items,r.purchaseTotal=0,r.priceTotal=0,r.items.forEach(function(e){r.purchaseTotal+=e.lent,r.priceTotal+=e.price},0)}).catch(function(e){r.isLoading=!1,r.error=e.data.message}))}e.branch.name?o():e.$on("branchLoaded",function(){o()}),r.dismissError=function(){r.error=""},r.print=function(){t.print()},r.openMinPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMinPickerOpen=!r.isMinPickerOpen},r.openMaxPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMaxPickerOpen=!r.isMaxPickerOpen},e.$watch("vm.min",function(e){e&&i()}),e.$watch("vm.max",function(e){e&&i()})}]),angular.module("MetalCtrl",["MetalService"]).controller("MetalController",["$scope","$translate","Page","Metal",function(e,t,a,n){var r=this;function o(){n.getMetals(e.branch._id).then(function(e){r.metals=e.data.metals}).catch(function(e){r.error=e.data.message})}a.section="metals",t.use,r.METAL={gold:{name:"Oro",purityUnit:"K"},silver:{name:"Plata",purityUnit:""}},e.branch.name?o():e.$on("branchLoaded",function(){o()}),r.dismissError=function(){r.error=""}}]),angular.module("MetalDetailsCtrl",["MetalService"]).controller("MetalDetailsController",["$scope","$stateParams","$translate","$uibModal","toastr","Metal",function(e,t,a,n,r,o){var i=this;function c(){o.getDetails(e.branch._id,t.metalId).then(function(e){i.metal=e.data.metal}).catch(function(e){i.error=e.data.message}).then(function(){i.isLoading=!1})}i.isLoading=!0,"en"===a.use()?(i.METAL={gold:{name:"Gold",purityUnit:"K"},silver:{name:"Silver",purityUnit:""}},i.MODAL_TEMPLATE=function(){return{title:"Withdraw "+i.METAL[i.metal.name].name,label:"Amount ("+i.branch.units.weight+")",action:"Withdraw",hideDescription:!0}}):(i.METAL={gold:{name:"Oro",purityUnit:"K"},silver:{name:"Plata",purityUnit:""}},i.MODAL_TEMPLATE=function(){return{title:"Retiro de "+i.METAL[i.metal.name].name,label:"Cantidad ("+i.branch.units.weight+")",action:"Retirar",hideDescription:!0}}),e.branch.name?c():e.$on("branchLoaded",function(){i.branch=e.branch,c()}),i.dismissError=function(){i.error=""},i.withdraw=function(){n.open({templateUrl:"/views/_cash-modal.html",controller:"CashModalController",resolve:{template:i.MODAL_TEMPLATE}}).result.then(function(e){o.withdraw(i.branch._id,i.metal._id,e.cash).then(function(e){r.success("Retiro registrado"),i.metal=e.data.metal}).catch(function(e){i.error=e.data.message})})}}]),angular.module("OverdueLayawaysReportCtrl",["ReportService"]).controller("OverdueLayawaysReportController",["$scope","$window","Report",function(e,t,a){var n=this;function r(){n.branch=e.branch,a.getOverdueLayaways(n.branch._id).then(function(e){n.isLoading=!1,n.items=e.data.items,i()},function(e){n.isLoading=!1,n.error=e.err.message})}function o(){return moment().startOf("day").subtract(n.daysAgo,"days").toDate()}function i(){n.items&&(n.totalPrice=0,n.totalCredited=0,n.totalBalance=0,n.count=0,n.items.forEach(function(e){(!n.isFiltered||new Date(e.layaway.createdAt)>n.until)&&(n.count++,n.totalPrice+=e.price,n.totalCredited+=e.layaway.credited,n.totalBalance+=e.layaway.balance)}))}n.today=new Date,n.isFiltered=!1,n.daysAgo=7,n.until=o(),n.isLoading=!0,e.branch.name?r():e.$on("branchLoaded",function(){r()}),n.changeDaysAgo=function(){n.daysAgo?(n.until=o(),i()):n.until=null},n.filterDaysAgo=function(e){return!n.isFiltered||(!n.until||new Date(e.layaway.endsOn)>n.until)},n.print=function(){t.print()}}]),angular.module("OverdueLoansReportCtrl",["ReportService"]).controller("OverdueLoansReportController",["$scope","$window","Report",function(e,t,a){var n=this;function r(){n.branch=e.branch,a.getOverdueLoans(n.branch._id).then(function(e){n.isLoading=!1,n.loans=e.data.loans.map(function(e){return e.overdueDays=moment(new Date).diff(new Date(e.endsOn),"days"),e}),i()}).catch(function(e){n.isLoading=!1,n.error=e.data.message})}function o(){return moment().startOf("day").subtract(n.daysAgo,"days").toDate()}function i(){var t;!n.loans||n.loans.length<=0||(t={count:0,loan:0,capital:0,interest:0,overdue:0,ticketReplacement:0,discount:0},n.loans.forEach(function(e){!n.isFiltered&&n.until&&new Date(e.endsOn)<=n.until||(t.count++,t.loan+=e.amount,t.capital+=e.capitalPaid,t.interest+=e.interestPaid,t.capital+=e.overduePaid,t.capital+=e.ticketReplacement,t.capital+=e.discountAmount)}),n.totals=t)}n.today=new Date,n.isFiltered=!1,n.daysAgo=3,n.until=o(),n.isLoading=!0,e.branch.name?r():e.$on("branchLoaded",function(){r()}),n.changeDaysAgo=function(){n.daysAgo?(n.until=o(),i()):n.until=null},n.filterDaysAgo=function(e){return!n.isFiltered||(!n.until||new Date(e.endsOn)>n.until)},n.print=function(){t.print()}}]),angular.module("PasswordDialogCtrl",[]).controller("PasswordDialogController",["$scope","$uibModalInstance","name",function(e,t,a){e.password="",e.confirm="",e.error="",e.name=a,e.ok=function(){return e.password&&e.confirm?e.password!==e.confirm?e.error="La contraseña y la confimación no coinciden":void t.close(e.password):e.error="Ambos campos son requeridos"},e.dismissError=function(){e.error=""},e.cancel=t.dismiss}]),angular.module("PaymentCtrl",[]).controller("PaymentController",["$scope","$uibModalInstance","template",function(a,t,n){a.template=n,a.fixedPayment=n.fixedPayment,a.additionalPayment=0,a.ticketReplacement=!1,a.ok=function(){var e=a.getTotalPayment();e&&t.close({payment:e,ticketReplacement:a.ticketReplacement})},a.getTotalPayment=function(){var e=0,t=parseFloat(a.additionalPayment);return(e=!isNaN(t)?t:e)+a.fixedPayment+(a.ticketReplacement?n.ticketReplacementCost:0)},a.getRemainder=function(){return(a.template.remainder||0)-a.additionalPayment-a.fixedPayment},a.onFixedChanged=function(){a.fixedPayment>n.fixedPayment&&(a.fixedPayment=n.fixedPayment)},a.cancel=t.dismiss}]),angular.module("PricingCtrl",[]).controller("PricingController",["Page",function(e){e.name="pricing"}]),angular.module("PublicCtrl",["PageService"]).controller("PublicController",["$scope","$stateParams","$translate","Page",function(e,t,a,n){"en"===t.lang?a.use("en"):a.use("es")}]),angular.module("PurchaseCtrl",["ClientService","ItemService","ConstantsService"]).controller("PurchaseController",["$scope","$state","$stateParams","$translate","Client","Item","Branch","Constants",function(n,t,e,a,r,o,i,c){function l(){r.getInfo(n.branch._id,e.clientId).then(function(e){n.client=e.data.client,n.header={backUrl:"/branch/"+n.branch._id+"/client/"+n.client._id}}),i.getSettings(n.branch._id).then(function(e){n.branchSettings=e.data.settings,n.allowedPurityGold=Object.keys(e.data.settings.allowedPurity.gold).map(function(e){return parseInt(e)}),n.allowedPuritySilver=Object.keys(e.data.settings.allowedPurity.silver).map(function(e){return parseInt(e)})})}n.autoCompleteResults=[],n.Page.section="inventory",n.items=[{}],n.client=null,n.isSaving=!1,n.weightUnitNames=c.weightUnitNames,n.branch.name?l():n.$on("branchLoaded",l),n.save=function(){var e;n.isSaving||n.items.length<=0||(n.isSaving=!0,(e=n.items.map(function(e){return o.parse(e,n.branch)})).some(function(e){return e.error})?n.isSaving=!1:o.purchase(n.branch._id,n.client._id,e).then(function(e){n.isSaving=!1,t.go("branch.client",{branchId:n.branch._id,clientId:n.client._id})}).catch(function(e){n.isSaving=!1,n.error=e.data.message}))},n.addItem=function(){n.items.push({})},n.removeItem=function(e){n.items.splice(n.items.indexOf(e),1)},n.getAppraisal=function(a){o.getAppraisal(a,n.branch.currency,n.branchSettings,function(e,t){e?n.error=e.message:a.lent=parseFloat(t.toFixed(2))})}}]),angular.module("PurchaseReceiptCtrl",["ItemService","ReportService"]).controller("PurchaseReceiptController",["$scope","$stateParams","Item","Report",function(t,e,a,n){var r=this;function o(){a.getDetails(e.branchId,e.itemId).then(function(e){r.item=e.data.item}).catch(function(e){e.data&&(t.$parent.error=e.data.message)}),n.getPurchaseReceiptSettings(e.branchId).then(function(e){t.$parent.template.header=e.data.settings.header,t.$parent.template.footer=e.data.settings.footer})}r.branchId=e.branchId,r.itemId=e.itemId,t.$parent.template={title:"Recibo de compra",backUrl:"/branch/"+r.branchId+"/item/"+r.itemId},t.branch&&t.branch.name?o():t.$on("branchLoaded",function(){o()})}]),angular.module("PurchasesReportCtrl",["ReportService"]).controller("PurchasesReportController",["$scope","$window","$timeout","Report",function(e,t,a,n){var r=this;function o(){a(function(){var e=new Date;r.min=moment().subtract(1,"month").toDate(),r.max=e},300),r.branch=e.branch,i()}function i(){r.min&&r.max&&(r.isLoading=!0,n.getPurchases(e.branch._id,moment(r.min).startOf("day").toDate(),moment(r.max).endOf("day").toDate()).then(function(e){r.isLoading=!1,r.items=e.data.items,r.purchaseTotal=0,r.priceTotal=0,r.items.forEach(function(e){r.purchaseTotal+=e.lent,r.priceTotal+=e.price},0)}).catch(function(e){r.isLoading=!1,r.error=e.data.message}))}e.branch.name?o():e.$on("branchLoaded",function(){o()}),r.dismissError=function(){r.error=""},r.print=function(){t.print()},r.openMinPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMinPickerOpen=!r.isMinPickerOpen},r.openMaxPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMaxPickerOpen=!r.isMaxPickerOpen},e.$watch("vm.min",function(e){e&&i()}),e.$watch("vm.max",function(e){e&&i()})}]),angular.module("ReceiptCtrl",["BranchService"]).controller("ReceiptController",["$scope","$window","$stateParams","tmhDynamicLocale","Branch",function(t,e,a,n,r){var o=this;o.now=new Date,r.get(a.branchId).then(function(e){t.branch=e.data.branch,n.set(e.data.branch.localeCode.toLowerCase()),t.$broadcast("branchLoaded")}),o.print=function(){e.print()},o.dismissError=function(){o.error=""}}]),angular.module("RecoverCtrl",["UserService"]).controller("RecoverController",["$scope","$stateParams","$window","$translate","User",function(t,e,a,n,r){t.formData={token:e.token},t.alerts=[],t.isValidLink=!1,t.error=null;var o={},o="es"===n.use()?{NEW_PASSWORD_REQUIRED:"Ingresa la nueva contraseña.",NEW_PASSWORD_VALIDATION:"Tu nueva contraseña debe ser por lo menos de 8 caracteres.",PASSWORDS_MiSMATCH:"Tu nueva contraseña y la confirmación no coinciden.",INVALID_TOKEN:"Este enlace es inválido o ha expirado."}:{NEW_PASSWORD_REQUIRED:"Oops. You forgot to type a new password.",NEW_PASSWORD_VALIDATION:"Your new password must contain at least 8 characters.",PASSWORDS_MiSMATCH:"Password and confirmation do not match.",INVALID_TOKEN:"This link is invalid or has expired."};r.validateRecoveryToken(e.token).then(function(e){t.isValidLink=e.data.success}).catch(function(e){t.isValidLink=!1,t.error=o.INVALID_TOKEN}),t.reset=function(){t.formData.password?t.formData.password.length<8?t.alerts.push({message:o.NEW_PASSWORD_VALIDATION}):t.formData.password!==t.formData.confirm?t.alerts.push({message:o.PASSWORDS_MISMATCH}):r.resetPassword(t.formData).then(function(e){e.data.success&&(a.location="/")}).catch(function(e){t.alerts.push(e.data)}):t.alerts.push({message:o.NEW_PASSWORD_REQUIRED})}}]),angular.module("RegisterCtrl",["UserService"]).controller("RegisterController",["$scope","$window","$analytics","User",function(t,e,a,n){t.$parent.isAuthenticated?e.location="/":(t.Page.name="register",t.formData={},t.errorMessage="",t.register=function(){t.isSaving||(t.isSaving=!0,t.formData.timezoneOffset=(new Date).getTimezoneOffset(),n.register(t.formData).then(function(e){t.isSaving=!1,e.data.success?(t.isRegistered=!0,heap.track("Register"),a.eventTrack("Register",{category:"Register"})):t.errorMessage=e.data.message}).catch(function(e){t.isSaving=!1,t.errorMessage=e.data.message}))},t.formChange=function(){t.errorMessage=""},t.resend=function(){t.formData.email&&(n.resend(t.formData.email),t.hasResentVerification=!0)})}]),angular.module("ReportCtrl",["BranchService"]).controller("ReportController",["$scope","$uibModal","toastr","Page","Branch",function(t,e,a,n,r){n.section="report";n=this;n.user=t.user,n.currentMonth=(new Date).getMonth()+1,n.deposit=function(){e.open({templateUrl:"views/_cash-modal.html",controller:"CashModalController",resolve:{template:function(){return{title:"Depósito a caja",label:"Cantidad",action:"Depositar"}}}}).result.then(function(e){r.deposit(t.branch._id,e).then(function(e){a.success("Depósito registrado")}).catch(function(e){a.error(e.data.message)})})},n.withdraw=function(){e.open({templateUrl:"views/_cash-modal.html",controller:"CashModalController",resolve:{template:function(){return{title:"Retiro de caja",label:"Cantidad",action:"Retirar"}}}}).result.then(function(e){r.withdraw(t.branch._id,e).then(function(e){a.success("Retiro registrado")}).catch(function(e){a.error(e.data.message)})})},n.expense=function(){e.open({templateUrl:"views/_cash-modal.html",controller:"CashModalController",resolve:{template:function(){return{title:"Registrar gasto",label:"Cantidad",action:"Retirar"}}}}).result.then(function(e){r.expense(t.branch._id,e).then(function(e){a.success("Gasto registrado")}).catch(function(e){a.error(e.data.message)})})}}]),angular.module("SaleReceiptCtrl",["ItemService","ReportService"]).controller("SaleReceiptController",["$scope","$stateParams","Item","Report",function(t,e,a,n){var r=this;function o(){a.getDetails(e.branchId,e.itemId).then(function(e){r.item=e.data.item}).catch(function(e){e.data&&(t.$parent.error=e.data.message)}),n.getSaleReceiptSettings(e.branchId).then(function(e){t.$parent.template.header=e.data.settings.header,t.$parent.template.footer=e.data.settings.footer})}r.branchId=e.branchId,r.itemId=e.itemId,t.$parent.template={title:"Recibo de venta",backUrl:"/branch/"+r.branchId+"/item/"+r.itemId},t.branch&&t.branch.name?o():t.$on("branchLoaded",function(){o()})}]),angular.module("SalesReportCtrl",["ReportService"]).controller("SalesReportController",["$scope","$window","$timeout","Report",function(e,t,a,n){var r=this;function o(){a(function(){var e=new Date;r.min=moment().subtract(1,"month").toDate(),r.max=e},300),r.branch=e.branch,i()}function i(){r.min&&r.max&&(r.isLoading=!0,n.getSales(e.branch._id,moment(r.min).startOf("day").toDate(),moment(r.max).endOf("day").toDate()).then(function(e){r.isLoading=!1,r.items=e.data.items,r.purchaseTotal=0,r.priceTotal=0,r.items.forEach(function(e){r.purchaseTotal+=e.lent,r.priceTotal+=e.price},0)}).catch(function(e){r.isLoading=!1,r.error=e.data.message}))}e.branch.name?o():e.$on("branchLoaded",function(){o()}),r.dismissError=function(){r.error=""},r.print=function(){t.print()},r.openMinPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMinPickerOpen=!r.isMinPickerOpen},r.openMaxPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMaxPickerOpen=!r.isMaxPickerOpen},e.$watch("vm.min",function(e){e&&i()}),e.$watch("vm.max",function(e){e&&i()})}]),angular.module("SettledLoansReportCtrl",["ReportService"]).controller("SettledLoansReportController",["$scope","$window","$timeout","Report",function(e,t,a,n){var r=this;function o(){a(function(){var e=new Date;r.min=moment().subtract(1,"month").toDate(),r.max=e},300),r.branch=e.branch,i()}function i(){r.min&&r.max&&(r.isLoading=!0,n.getSettledLoans(r.branch._id,r.min,r.max).then(function(e){var t;r.isLoading=!1,r.loans=e.data.loans,!r.loans||r.loans.length<=0||(t={count:0,loan:0,capital:0,interest:0,overdue:0,ticketReplacement:0,discount:0},r.loans.forEach(function(e){t.count++,t.loan+=e.amount,t.capital+=e.capitalPaid,t.interest+=e.interestPaid,t.capital+=e.overduePaid,t.capital+=e.ticketReplacement,t.capital+=e.discountAmount}),r.totals=t)}).catch(function(e){r.isLoading=!1,r.error=e.data.message}))}e.branch.name?o():e.$on("branchLoaded",function(){o()}),r.openMinPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMinPickerOpen=!r.isMinPickerOpen},r.openMaxPicker=function(e){e.preventDefault(),e.stopPropagation(),r.isMaxPickerOpen=!r.isMaxPickerOpen},e.$watch("vm.min",function(e){e&&i()}),e.$watch("vm.max",function(e){e&&i()}),r.changeDaysAgo=function(){i()},r.print=function(){t.print()}}]),angular.module("SubscribeCtrl",["CompanyService"]).controller("SubscribeController",["$scope","$window","Page","Company",function(t,a,e,n){var r=this;function o(e){r.isProcessingOrder=!0,n.updatePaymentMethod(e.id,r.selectedPlan.id).then(function(e){a.location="/subscribe",heap.track("Subscribed")}).catch(function(e){r.error=e.data.message}).then(function(){r.isProcessingOrder=!1})}e.section="subscribe",r.plans={mensual:{name:"Mensual",id:"mensual-covid",price:699,crossed:"$1,399",display:"$699",currency:"MXN",periodicity:"mensualmente",period:"mes"},anual:{name:"Anual",id:"anual-covid",price:5999,crossed:"$11,988",display:"$5,999",currency:"MXN",periodicity:"anualmente",period:"año"}},r.selectedPlan=r.plans.mensual,r.selectPlan=function(e){r.selectedPlan=r.plans[e]},r.dismissError=function(){r.error=""},r.checkout=function(){var e=t.company.isLive?"pk_live_uexcyoHHSMRQ46pLa4RzgGcL":"pk_test_d9cxx4itVxX3pNUTTx5PuECc";a.StripeCheckout.configure({key:e,image:"/img//icon.png",locale:t.company.language||"es",token:o,name:"YoPresto",email:t.user.email,currency:t.user.currency,description:"en"===t.company.language?"Pro Subscription":"Suscripción Pro",allowRememberMe:!1,panelLabel:("en"===t.company.language?"Pay":"Pagar")+" $"+r.selectedPlan.price}).open()}}]),angular.module("SummaryCtrl",["BranchService","ConstantsService"]).controller("SummaryController",["$scope","$window","$filter","$timeout","$stateParams","Branch","Constants",function(e,t,a,n,r,o,s){var i=this;function c(){n(function(){var e=new Date;i.min=e,i.max=i.min},300),i.branch=e.branch,l()}function l(){o.getSummary(i.branch._id,i.min,i.max).then(function(e){i.openingBalance=e.data.openingBalance,i.summary=e.data.summary;e=Object.keys(i.summary);i.totalIncome=0,i.totalOutcome=0,i.totalIncomeCount=0,i.totalOutcomeCount=0,e.forEach(function(e){e=i.summary[e];"in"===e.flow?(i.totalIncome+=e.total,i.totalIncomeCount+=e.count):(i.totalOutcome+=e.total,i.totalOutcomeCount+=e.count)})}).catch(function(e){i.error=e.data.message})}e.minimum=new Date,e.branch.name?c():e.$on("branchLoaded",function(){c()}),i.dismissError=function(){i.error=""},i.print=function(){t.print()},i.openMinPicker=function(e){e.preventDefault(),e.stopPropagation(),i.isMinPickerOpen=!i.isMinPickerOpen},i.openMaxPicker=function(e){e.preventDefault(),e.stopPropagation(),i.isMaxPickerOpen=!i.isMaxPickerOpen},e.$watch("vm.min",function(e){e&&l()}),e.$watch("vm.max",function(e){e&&l()})}]),angular.module("ThankYouCtrl",[]).controller("ThankYouController",["Page","$location",function(e,t){e.name="thankyou"}]),angular.module("TicketCtrl",["yp.dynamicFilter","percentageFilter","TicketService"]).controller("TicketController",["$window","$stateParams","Ticket",function(e,t,a){var n=this;n.branchId=t.branchId,n.loanId=t.loanId,a.generateTicket(t.branchId,t.loanId).then(function(e){n.ticket=e.data.ticket}).catch(function(e){n.error=e.data.message}),n.dismissError=function(){n.error=""},n.print=function(){e.print()}}]),angular.module("TicketEditCtrl",["TicketService","yp.directives.ypFieldPop"]).controller("TicketEditController",["$state","Upload","Ticket",function(e,t,a){var n=this,r=(n.format={},n.format.size="letter",n.newField=null,{letter:{width:215.9,height:279.4},a4:{width:210,height:297},legal:{width:215.9,height:355.6}});function o(e,t){var a=window.document.getElementById("field-region");return{x:e/a.offsetWidth*r[n.format.size].width,y:t/a.offsetHeight*r[n.format.size].height}}a.getTicket().then(function(e){n.format=e.data.ticket}),n.uploadTemplate=function(e){e.length&&t.upload({url:"/api/company/ticket/template",file:e[0]}).progress(function(e){e=parseInt(100*e.loaded/e.total);n.progress=e}).success(function(e,t){n.timestamp=(new Date).getTime()})},n.removeTemplate=function(){a.removeTemplate().then(function(){n.timestamp=(new Date).getTime()})},n.toggleDrawMode=function(){n.isDrawModeOn=!n.isDrawModeOn,n.isDrawModeOn&&(n.newField={x:0,y:0,width:0,height:0},n.isDrawingField=!1)},n.startDrawingField=function(e){if(!n.isDrawModeOn)return!1;n.isDrawingField?n.stopDrawingField():(n.isDrawingField=!0,e=o(e.offsetX,e.offsetY),n.newField.x=e.x,n.newField.y=e.y)},n.resizeNewField=function(e){if(!n.isDrawModeOn)return!1;var t;n.isDrawingField&&(e="field-region"===e.target.id?(t=e.offsetX,e.offsetY):(t=e.offsetX+e.target.offsetLeft,e.offsetY+e.target.offsetTop),e=(t=o(t,e)).x-n.newField.x,t=t.y-n.newField.y,n.newField.width=Math.abs(e),n.newField.height=Math.abs(t))},n.stopDrawingField=function(e){if(!n.isDrawModeOn)return!1;n.isDrawingField=!1,n.isDrawModeOn=!1},n.cancelDrawingField=function(){n.newField=null},n.addField=function(){n.newField&&n.newField.variable&&(n.format.fields.push(n.newField),n.newField=null)},n.removeField=function(e){n.format.fields.splice(n.format.fields.indexOf(e),1)},n.save=function(){a.save(n.format).then(function(){heap.track("Save ticket"),e.go("company.ticket")}).catch(function(e){n.error=e.data.message})},n.closeError=function(){n.error=""},n.togglePrintTemplate=function(){n.format.printTemplate=!n.format.printTemplate},n.print=function(){window.print()}}]),angular.module("UpgradeModalCtrl",[]).controller("UpgradeModalController",["$scope","$uibModalInstance",function(e,t){e.cancel=t.dismiss}]),angular.module("VerifyCtrl",["UserService"]).controller("VerifyController",["$stateParams","$scope","$location","$translate","User",function(e,t,a,n,r){function o(){e.code&&r.verify(e.code).then(function(e){t.isVerifying=!1,e.data.success?t.success=!0:t.error=e.data.message}).catch(function(e){t.isVerifying=!1})}t.lang=n.use(),t.error="",t.isVerifying=!0,window.scope=t,r.info().then(function(e){return e.data.user&&e.data.user.isVerified?(t.success=!0,void(t.isVerifying=!1)):void o()}).catch(function(e){o()})}]),angular.module("VideoLandingModalCtrl",[]).controller("VideoLandingModalController",["$scope","$uibModalInstance",function(e,t){e.cancel=function(){t.dismiss()},e.ok=function(){t.close()}}]),angular.module("WebcamCtrl",[]).controller("WebcamController",["$scope","$document","$uibModalInstance",function(e,t,a){e.isFrozen=!1,t.ready(function(){Webcam.set({width:640,height:480,dest_width:1024,dest_height:768,image_format:"jpeg",jpeg_quality:90}),Webcam.set("constraints",{optional:[{minWidth:640}],required:[{maxWidth:1024}]}),Webcam.attach("#webcam")}),e.takeSnapshot=function(){Webcam.freeze(),e.isFrozen=!0},e.discardSnapshot=function(){Webcam.unfreeze(),e.isFrozen=!1},e.saveSnapshot=function(){Webcam.snap(function(e){Webcam.reset(),a.close(e)})},e.cancel=function(){Webcam.reset(),a.dismiss()}}]),angular.module("WelcomeCtrl",[]).controller("WelcomeController",["$state","$uibModalInstance",function(e,t){this.cancel=t.dismiss,this.continue=function(){e.go("branch.settings"),t.dismiss()}}]),angular.module("YesNoCtrl",["paragraphsToArrayFilter"]).controller("YesNoController",["$scope","$uibModalInstance","template",function(e,t,a){e.template=a,e.ok=function(){t.close(!0)},e.cancel=t.dismiss}]),angular.module("yp.dynamicFilter",[]).filter("dynamicFilter",["$interpolate",function(a){return function(e,t){return t?a("{{value | "+t+"}}")({value:e}):e}}]),angular.module("paragraphsToArrayFilter",[]).filter("paragraphsToArray",function(){return function(e){return e?e.split("\n").filter(function(e){return!!e}):[]}}),angular.module("percentageFilter",[]).filter("percentage",["$filter",function(a){return function(e,t){return a("number")(100*e,t)+"%"}}]),angular.module("BranchService",[]).factory("Branch",["$http",function(n){return{get:function(e){return n.get("/api/branch/"+e)},getAll:function(){return n.get("/api/branches")},remove:function(e){return n.delete("/api/branch/"+e)},create:function(e){return n.post("/api/branch",{branch:e})},getCategories:function(e){return n.get("/api/branch/"+e+"/categories")},getCategory:function(e,t){return n.get("/api/branch/"+e+"/category/"+t)},editCategory:function(e,t,a){return n.put("/api/branch/"+e+"/category/"+t,a)},createCategory:function(e,t){return n.post("/api/branch/"+e+"/category",t)},removeCategory:function(e,t){return n.delete("/api/branch/"+e+"/category/"+t)},getSettings:function(e){return n.get("/api/branch/"+e+"/settings")},getIntl:function(){return n.get("/api/intl")},saveSettings:function(e,t){return n.put("/api/branch/"+e+"/settings",t)},getUsers:function(e){return n.get("/api/branch/"+e+"/users")},createUser:function(e,t){return n.post("/api/branch/"+e+"/user",t)},removeUser:function(e,t){return n.delete("/api/branch/"+e+"/user/"+t)},changeUserPassword:function(e,t,a){return n.put("/api/branch/"+e+"/user/"+t+"/password",{password:a})},changeUserAccessHours:function(e,t,a){return n.put("/api/branch/"+e+"/user/"+t+"/accessHours",{accessHours:a})},getCashflow:function(e,t,a){return n.get("/api/branch/"+e+"/cashflow",{params:{min:t,max:a}})},getSummary:function(e,t,a){return n.get("/api/branch/"+e+"/summary",{params:{min:t,max:a}})},removeAllData:function(e){return n.delete("/api/branch/"+e+"/data")},deposit:function(e,t){return n.post("/api/branch/"+e+"/deposit",t)},withdraw:function(e,t){return n.post("/api/branch/"+e+"/withdrawal",t)},expense:function(e,t){return n.post("/api/branch/"+e+"/expense",t)},editLayawayCategory:function(e,t){return n.put("/api/branch/"+e+"/layawayCategory/"+t._id,t)},createLayawayCategory:function(e,t){return n.post("/api/branch/"+e+"/layawayCategory",t)},removeLayawayCategory:function(e,t){return n.delete("/api/branch/"+e+"/layawayCategory/"+t)},getLayawayCategories:function(e){return n.get("/api/branch/"+e+"/layawayCategories")},getPeriodObjectFromPeriod:function(e,t){if("en"===t)switch(e){case"month":return{name:"monthly",plural:"months",singular:"month"};case"30-day":return{name:"each 30 days",plural:"30-days periods",singular:"30-days period"};case"fort":return{name:"each 15 days",plural:"15-days periods",singular:"15-days period"};case"week":return{name:"weekly",plural:"weeks",singular:"week"};case"day":return{name:"diary",plural:"days",singular:"day"}}else switch(e){case"month":return{name:"mensual",plural:"meses",singular:"mes"};case"30-day":return{name:"cada 30 días",plural:"periodos de 30 días",singular:"periodo de 30 días"};case"fort":return{name:"cada 15 días",plural:"periodos de 15 días",singular:"periodo de 15 días"};case"week":return{name:"semanal",plural:"semanas",singular:"semana"};case"day":return{name:"diario",plural:"días",singular:"día"}}}}}]),angular.module("ClientService",[]).factory("Client",["$http",function(n){return{search:function(e,t){return n.get("/api/branch/"+e+"/clients",{params:t})},autoComplete:function(e,t){return n.get("/api/branch/"+e+"/autocomplete/clients/"+t)},getDetails:function(e,t){return n.get("/api/branch/"+e+"/client/"+t)},getInfo:function(e,t){return n.get("/api/branch/"+e+"/client/"+t+"/info")},create:function(e,t){return n.post("/api/branch/"+e+"/client",t)},update:function(e,t){return n.put("/api/branch/"+e+"/client/"+t._id,t)},delete:function(e,t){return n.delete("/api/client/"+t)},uploadPicture:function(e,t,a){return n.post("/api/branch/"+e+"/client/"+t+"/picture",{file:a})},deletePicture:function(e,t,a){return n.delete("/api/branch/"+e+"/client/"+t+"/picture/"+a)},pictures:function(e,t){return n.get("/api/branch/"+e+"/client/"+t+"/pictures")},block:function(e,t){return n.post("/api/branch/"+e+"/client/"+t+"/block")},unblock:function(e,t){return n.delete("/api/branch/"+e+"/client/"+t+"/block")}}}]),angular.module("CompanyService",[]).factory("Company",["$http",function(a){return{getName:function(){return a.get("/api/company")},getInfo:function(){return a.get("/api/company/info")},editInfo:function(e){return a.put("/api/company/info",{info:e})},getBranches:function(){return a.get("/api/company/branches")},getTicket:function(){return a.get("/api/company/ticket")},saveTicket:function(e){return a.put("/api/company/ticket",e)},getCountryCodes:function(){return a.get("/api/countrycodes")},getUsage:function(){return a.get("/api/company/usage")},updatePaymentMethod:function(e,t){return a.put("/api/company/paymentmethod",{token:e,plan:t})},getBilling:function(){return a.get("/api/company/billing")},getInvoicingInfo:function(){return a.get("/api/company/invoicing")},editInvoicingInfo:function(e){return a.post("/api/company/invoicing",e)}}}]),angular.module("ConstantsService",[]).factory("Constants",["$translate",function(e){var t,a,n,r,o,i,c,l,s,e="en"===e.use()?(t={g:"grams",oz:"ounces",dwt:"pennyweights"},n=a={active:"Active",overdue:"Overdue",expireReady:"Expiration pending",expired:"Expired",settled:"Settled",cancelled:"Cancelled"},r={month:"Monthly","30-day":"30 days",fort:"Biweekly",week:"Weekly",day:"Daily"},o={month:"months","30-day":"30-days periods",fort:"15-days periods",week:"weeks",day:"days"},i={month:"month","30-day":"30-days period",fort:"15-days period",week:"week",day:"day"},c={0:"Loan",1:"Interest generated",2:"Interest payment",3:"Credit to principal",4:"Overdue interest",5:"Overdue interest",6:"Overdue interest payment",7:"Discount",8:"Penalty",9:"Anticipated interest",10:"Ticket replacement"},l={0:"Loan",1:"Overdue interest payment",2:"Interest payment",3:"Credit to principal",4:"Credit to layaway",5:"Sale",6:"Purchase",7:"Loan cancellation",8:"Deposit",9:"Withdraw",10:"Purchase cancellation",11:"Expired layaway",12:"Sale cancellation",13:"Expense",14:"Ticket replacement"},s={loan:"Loan",overdue:"Overdue payment",interest:"Interest payment",credited:"Credit to principal",layaway:"Credit to layaway",sale:"Sale",purchase:"Purchase",cancellation:"Loan cancellation",withdrawal:"Withdrawal",deposit:"Deposit",purchaseCancellation:"Purchase cancellation",expiredLayaway:"Expired layaway",saleCancellation:"Sale cancellation",expense:"Expense",ticketReplacement:"Ticket replacement"},{0:{message:"Incorrect email or password"},1:{message:"Outside working hours"},2:{message:"Account inactive"},3:{message:"Account deleted. Please contact welcome@yopresto.com to restore access."},4:{message:"You haven not verified your email. Please follow the link we sent to you."}}):(t={g:"gramos",oz:"onzas",dwt:"pennyweights"},a={active:"Activo",overdue:"Vencido",expireReady:"Expiración pendiente",expired:"Expirado",settled:"Liquidado",cancelled:"Cancelado"},n={active:"activos",overdue:"vencidos",expired:"expirados",settled:"liquidados",cancelled:"cancelados",all:"todos los préstamos"},r={month:"Mensual","30-day":"30 días",fort:"15 días",week:"Semanal",day:"Diario"},o={month:"meses","30-day":"periodos de 30 días",fort:"periodos de 15 días",week:"semanas",day:"días"},i={month:"mes","30-day":"periodo de 30 días",fort:"periodo de 15 días",week:"semana",day:"día"},c={0:"Préstamo",1:"Intereses generados",2:"Pago de intereses",3:"Abono a capital",4:"Interés extemporáneo",5:"Interés extemporáneo",6:"Pago de interés extemporáneo",7:"Descuento",8:"Multa",9:"Interés anticipado",10:"Reposición de boleta"},l={0:"Préstamo",1:"Pago de interés extemporáneo",2:"Pago de intereses",3:"Abono a capital",4:"Abono a apartado",5:"Venta",6:"Compra",7:"Cancelación de préstamo",8:"Depósito",9:"Retiro",10:"Cancelación de compra",11:"Apartado expirado",12:"Cancelación de venta",13:"Gasto",14:"Reposición de boleta"},s={loan:"Préstamo",overdue:"Pago de interés extemporáneo",interest:"Pago de intereses",credited:"Abono a capital",layaway:"Abono a apartado",sale:"Venta",purchase:"Compra",cancellation:"Cancelación",withdrawal:"Retiro",deposit:"Depósito",purchaseCancellation:"Cancelación de compra",expiredLayaway:"Apartado expirado",saleCancellation:"Cancelación de venta",expense:"Gasto",ticketReplacement:"Reposición de boleta"},{0:{message:"Correo o contraseña incorrectos"},1:{message:"Fuera del horario de trabajo"},2:{message:"Cuenta inactiva"},3:{message:"Cuenta eliminada. Contacte a soporte@yopresto.com para restablecer el acceso."},4:{message:"No has verificado tu correo electrónico."}});return{weightUnitNames:t,loanStatus:a,loanStatusPlural:n,loanPeriod:r,loanPluralizedPeriod:o,loanSingularPeriod:i,loanLog:c,cashflowLog:l,cashflowConcepts:s,LoginStatus:e}}]),angular.module("HomeService",[]).factory("Home",["$http",function(t){return{sendMessage:function(e){return t.post("/api/prospect/message",e)}}}]);var GRAMS_IN_ONE_TROY_OUNCE=31.1034768,PENNYWEIGHTS_IN_ONE_TROY_OUNCE=20,OUNCES_IN_ONE_TROY_OUNCE=1.097143;angular.module("ItemService",[]).factory("Item",["$http","$translate",function(c,i){return{search:function(e,t){return c.get("/api/branch/"+e+"/items",{params:t})},getDetails:function(e,t){return c.get("/api/branch/"+e+"/item/"+t)},edit:function(e,t,a){return c.put("/api/branch/"+e+"/item/"+t,a)},uploadPicture:function(e,t,a){return c.post("/api/branch/"+e+"/item/"+t+"/picture",{file:a})},deletePicture:function(e,t,a){return c.delete("/api/branch/"+e+"/item/"+t+"/picture/"+a)},parse:function(e,t){var a,n=i.use(),r="en"===n?{gold:"Gold",silver:"Silver"}:{gold:"Oro",silver:"Plata"},o="en"===n?"Serial No.":"No. Serie";switch(e.details||(e.details={}),e.type){case"object":a={type:e.type,description:(e.description.main+" "+e.description.brand+" "+(e.description.model||"")).trim(),details:e.details.serial?("en"===n?"Serial ":"Serie ")+e.details.serial:""};break;case"jewl":(a={type:e.type,description:(e.description.main+" "+r[e.description.metal]).trim(),details:e.details.weight+" "+t.units.weight+" "+e.details.purity+("gold"===e.description.metal.toLowerCase()?"K":""),jewl:e.details}).jewl.metal=e.description.metal;break;case"vehicle":a={type:e.type,description:(e.description.brand+" "+e.description.line+" "+e.description.model).trim(),details:((e.details.serial?o+e.details.serial+" ":"")+(e.details.mileage?e.details.mileage+t.units.distance:"")).trim()};break;default:return{error:{message:"Not a valid item type"}}}return a.comment=e.comment,a.lent=e.lent,a.appraisal=e.appraisal,a.price=e.price,a},purchase:function(e,t,a){return c.post("/api/branch/"+e+"/client/"+t+"/purchase",{items:a,date:new Date})},getAppraisal:function(n,e,r,o){if(!n.description||!n.description.metal)return window.alert("Selecciona el tipo de metal");if(!n.details||!n.details.weight)return window.alert("Selecciona el peso del metal");if(!n.details.purity)return window.alert("Selecciona la pureza del metal");var i=0,t="";if("gold"===n.description.metal){if(n.details.purity<8||24<n.details.purity)return window.alert("La pureza del oro debe ser un valor entre 8 y 24");i=n.details.purity/24,t="XAU"}else if("silver"===n.description.metal){if(n.details.purity<1||999<n.details.purity)return window.alert("La pureza de la plata debe ser un valor entre 1 y 999");i=n.details.purity/999,t="XAG"}c.get("https://query.yahooapis.com/v1/public/yql?q=select * from yahoo.finance.xchange where pair in ('"+e+"', '"+t+"')&format=json&env=store://datatables.org/alltableswithkeys").then(function(e){var t,a=e.data.query.results.rate[0].Rate,e=e.data.query.results.rate[1].Rate;switch(r.units.weight){case"oz":t=OUNCES_IN_ONE_TROY_OUNCE;break;case"dwt":t=PENNYWEIGHTS_IN_ONE_TROY_OUNCE;break;default:t=GRAMS_IN_ONE_TROY_OUNCE}a=a/(e*t)*n.details.weight*i*r.metalValuationRate;return o(null,a)}).catch(function(e){o(e.data)})},pictures:function(e,t){return c.get("/api/branch/"+e+"/item/"+t+"/pictures")},layAway:function(e,t,a,n,r){return c.post("/api/branch/"+e+"/item/"+t+"/layaway",{client:a,amount:n,layawayCategory:r})},creditLayaway:function(e,t,a){return c.put("/api/branch/"+e+"/item/"+t+"/layaway",{amount:a})},sell:function(e,t,a){return c.put("/api/branch/"+e+"/item/"+t+"/sell",{client:a})},cancelPurchase:function(e,t){return c.delete("/api/branch/"+e+"/item/"+t)},cancelSale:function(e,t){return c.delete("/api/branch/"+e+"/item/"+t+"/sale")},expireLayaway:function(e,t){return c.delete("/api/branch/"+e+"/item/"+t+"/layaway")},melt:function(e,t){return c.put("/api/branch/"+e+"/item/"+t+"/melt")}}}]),angular.module("LoanService",[]).factory("Loan",["$http",function(r){return{create:function(e,t,a,n){return r.post("/api/branch/"+e+"/client/"+t+"/loan",{loan:a,items:n})},recalcEndDate:function(e,t){return r.put("/api/branch/"+e+"/loan/"+t+"/recalc-end-date")},getDetails:function(e,t){return r.get("/api/branch/"+e+"/loan/"+t,{params:{date:new Date}})},pay:function(e,t,a,n){return r.post("/api/branch/"+e+"/loan/"+t+"/payment",{payment:a,date:new Date,ticketReplacement:n})},discount:function(e,t,a){return r.post("/api/branch/"+e+"/loan/"+t+"/discount",{discount:a})},undoSettle:function(e,t){return r.delete("/api/branch/"+e+"/loan/"+t+"/settle")},undoPayment:function(e){return r.delete("/api/branch/"+e.branchId+"/loan/"+e.loanId+"/payment?createdOn="+e.createdOn)},undoDiscount:function(e){return r.delete("/api/branch/"+e.branchId+"/loan/"+e.loanId+"/discount?createdOn="+e.createdOn)},cancel:function(e,t){return r.put("/api/branch/"+e+"/loan/"+t+"/cancel")},expire:function(e,t){return r.put("/api/branch/"+e+"/loan/"+t+"/expire")},search:function(e,t){return r.get("/api/branch/"+e+"/loans",{params:t})}}}]),angular.module("MathUtilService",[]).factory("MathUtil",function(){return{roundToDecimals:function(e,t){void 0===t&&(t=2);t=Math.pow(10,t);return Math.round(e*t)/t}}}),angular.module("MetalService",[]).factory("Metal",["$http",function(n){return{getMetals:function(e){return n.get("/api/branch/"+e+"/metals")},getDetails:function(e,t){return n.get("/api/branch/"+e+"/metal/"+t)},withdraw:function(e,t,a){return n.put("/api/branch/"+e+"/metal/"+t,{amount:a})}}}]),angular.module("PageService",[]).factory("Page",[function(){var e={title:"YoPresto",name:"",locale:"es-mx",setTitle:function(e){this.title=e}};return e}]),angular.module("ProspectService",[]).factory("Prospect",["$http",function(t){return{register:function(e){return t.post("/api/prospect",e)}}}]),angular.module("ReportService",[]).factory("Report",["$http",function(n){return{getOverdueLoans:function(e){return n.get("/api/branch/"+e+"/report/overdueLoans")},getDueSoonLoans:function(e,t){return n.get("/api/branch/"+e+"/report/dueSoonLoans",{params:{until:t}})},getActiveLoans:function(e){return n.get("/api/branch/"+e+"/report/activeLoans")},getExpiredLoans:function(e,t){return n.get("/api/branch/"+e+"/report/expiredLoans",{params:{daysAgo:t}})},getSettledLoans:function(e,t,a){return n.get("/api/branch/"+e+"/report/settledLoans",{params:{min:t,max:a}})},getPurchases:function(e,t,a){return n.get("/api/branch/"+e+"/report/purchases",{params:{min:t,max:a}})},getSales:function(e,t,a){return n.get("/api/branch/"+e+"/report/sales",{params:{min:t,max:a}})},getMelted:function(e,t,a){return n.get("/api/branch/"+e+"/report/melted",{params:{min:t,max:a}})},getInventory:function(e,t,a){return n.get("/api/branch/"+e+"/report/inventory",{params:{status:t,type:a}})},getActiveLayaways:function(e,t,a){return n.get("/api/branch/"+e+"/report/activeLayaways")},getOverdueLayaways:function(e,t,a){return n.get("/api/branch/"+e+"/report/overdueLayaways")},getLayawayReceiptSettings:function(e){return n.get("/api/branch/"+e+"/receipt/layaway")},getSaleReceiptSettings:function(e){return n.get("/api/branch/"+e+"/receipt/sale")},getLoanPaymentReceiptSettings:function(e){return n.get("/api/branch/"+e+"/receipt/loanPayment")},getPurchaseReceiptSettings:function(e){return n.get("/api/branch/"+e+"/receipt/purchase")},getClients:function(e,t,a){return n.get("/api/branch/"+e+"/report/clients/"+t,{params:a})}}}]),angular.module("TicketService",[]).factory("Ticket",["$http",function(a){return{availableFields:[{id:"contract",name:"Folio",description:"Número de folio del contrato",example:"345"},{id:"date",name:"Fecha de préstamo",description:"Fecha de préstamo",example:"13-Mar-2015"},{id:"time",name:"Hora de préstamo",description:"Hora de préstamo",example:"11:16 a.m."},{id:"day",name:"Día",description:"Día del préstamo.",example:"24"},{id:"month",name:"Mes",description:"Mes del préstamo en letra.",example:"Septiembre"},{id:"year",name:"Año",description:"Año del préstamo.",example:"2015"},{id:"branchAddress",name:"Domicilio de la sucursal",description:"Domicilio de la sucursal donde se emite el préstamo.",example:"Calle Tamaulipas No. 3456 Int. 4, Colonia Doctores, Cd. de México, C.P. 06789"},{id:"branchPhone",name:"Teléfono de la sucursal",description:"Teléfono de la sucursal donde se emite el préstamo.",example:"01(555)555-55-55"},{id:"clientName",name:"Cliente",description:"Nombre completo del cliente.",example:"Juan Adolfo Flores Holguín"},{id:"clientAddress",name:"Domicilio del cliente",description:"Domicilio del cliente.",example:"Av. Monterrey No. 125 Int. 12, Colonia Roma Norte, Cd. de México, C.P. 06789"},{id:"clientPhone",name:"Teléfono del cliente",description:"Teléfono del cliente.",example:"01(555)843-45-02"},{id:"clientIdType",name:"Tipo de ID",description:"Tipo de identificación del cliente.",example:"Licencia de conducir"},{id:"clientIdNumber",name:"Num. de ID",description:"Número de identificación del cliente.",example:"12345678903456789"},{id:"coOwnerName",name:"Cotitular",description:"Persona adicional facultada para reclamar las prendas.",example:"Pedro Armando Flores Holguín"},{id:"coOwnerAddress",name:"Domicilio del cotitular",description:"Domicilio del cotitular.",example:"Blv. Álvaro Obregón No. 343 Int. 3, Colonia Doctores, D.F., C.P. 86789"},{id:"cat",name:"CAT",description:"Costo Anual Total.",example:"143.2%"},{id:"cmt",name:"Costo Mensual Total",description:"CAT entre 12 meses.",example:"11.9%"},{id:"cdt",name:"Costo Diario Total",description:"CAT entre 360 días.",example:"0.4%"},{id:"anualRate",name:"Tasa de Interés Anual",description:"Tasa de interés anual.",example:"120.345%"},{id:"loan",name:"Préstamo",description:"Monto total del préstamo.",example:"$10,000.00"},{id:"loanNumeral",name:"Préstamo en letras",description:"Préstamo escrito en letras.",example:"DIEZ MIL"},{id:"appraisal",name:"Avalúo",description:"Valor estimado de las prendas empeñadas.",example:"$12,000.00"},{id:"appraisalNumeral",name:"Avalúo en letras",description:"Avalúo escrito en letras.",example:"CINCO MIL PESOS"},{id:"loanAppraisalRate",name:"Porcentaje de préstamo sobre el avalúo",description:"Porcentaje resultado de dividir el préstamo otorgado entre el valor de las prendas.",example:"83.33%"},{id:"renewalAmount",name:"Refrendo",description:"Monto a pagar para refrendar al término del plazo.",example:"$3,456.00"},{id:"claimAmount",name:"Desempeño",description:"Monto a pagar para desempeñar al término el plazo.",example:"$13,456.00"},{id:"items",name:"Prendas",description:"Descripción de las prendas",example:'Televisión Pantalla LED 60" SHARP QUATRON'},{id:"comment",name:"Observaciones",description:"Observaciones de la prenda",example:"Sin control remoto"},{id:"period",name:"Periodo",description:"Periodo de cobro de intereses.",example:"Quincenal"},{id:"term",name:"Plazo",description:"Número de periodos antes de vencimiento.",example:"3"},{id:"financeRate",name:"Interés por financiamiento",description:"Porcentaje de interés por financiamiento.",example:"13%"},{id:"financeAmount",name:"Monto por financiamiento",description:"Cantidad a cobrar por financiamiento.",example:"$1,300.00"},{id:"storageRate",name:"Interés por almacenaje",description:"Porcentaje de interés por almacenaje.",example:"5%"},{id:"storageAmount",name:"Monto por almacenaje",description:"Cantidad a cobrar por almacenaje.",example:"$500.00"},{id:"vatRate",name:"I.V.A.",description:"Porcentaje del I.V.A.",example:"16%"},{id:"vatAmount",name:"Monto por I.V.A.",description:"Cantidad a cobrar por I.V.A.",example:"$1,600.00"},{id:"ticketReplacementCost",name:"Reposición de boleta",description:"Cantidad a cobrar por reimpresión de contrato extraviado",example:"$10.00"},{id:"totalRate",name:"Interés total",description:"Porcentaje de interés a cobrar en el periodo.",example:"20.88%"},{id:"totalAmount",name:"Monto total por intereses",description:"Cantidad total a cobrar por intereses en el periodo.",example:"$2,088.00"},{id:"anticipatedRate",name:"Interés por reclamo anticipado",description:"Porcentaje de interés por reclamo anticipado.",example:"5%"},{id:"anticipatedAmount",name:"Monto por reclamo anticipado",description:"Cantidad a cobrar por reclamo anticipado.",example:"$500.00"},{id:"anticipatedDays",name:"Días de reclamo anticipado",description:"Número de días en que se aplica el interés por reclamo anticipado.",example:"15"},{id:"overdueRate",name:"Interés por reclamo extemporáneo",description:"Porcentaje de interés por reclamo extemporáneo.",example:"5%"},{id:"overdueAmount",name:"Monto por reclamo expemporáneo",description:"Cantidad a cobrar por reclamo expemporáneo.",example:"$500.00"},{id:"commercializationRate",name:"Interés por comercialización",description:"Porcentaje de comisión en caso de venta.",example:"10%"},{id:"commercializationAmount",name:"Monto por comercialización",description:"Cantidad a cobrar de comisión en caso de venta.",example:"$1000.00"},{id:"expiration",name:"Fecha de vencimiento",description:"Fecha en que termina el plazo.",example:"13-Jun-2015"},{id:"grace",name:"Días de gracia",description:"Número de días después de la fecha de vencimiento sin cobrar intereses.",example:"7"},{id:"expirationWithGrace",name:"Fecha después de los días de gracia",description:"Fecha en que termina el plazo, sumando los días de gracia.",example:"20-Jun-2015"},{id:"commercializationDays",name:"Días antes de comercialización",description:"Número de días después de los días de gracia en que el cliente puede reclamar la prenda antes de pasar a venta.",example:"3"},{id:"commercializationDate",name:"Fecha de comercialización",description:"Fecha después de los días de gracia, sumando los días para comercialización.",example:"23-Jun-2015"},{id:"registeredBy",name:"Nombre del valuador",description:"Nombre del usuario que registra el préstamo.",example:"Juan López"},{id:"loan1",name:"Préstamo Periodo 1",description:"Monto total del préstamo a mostrar en el primer periodo.",example:"$10,000.00"},{id:"loan2",name:"Préstamo Periodo 2",description:"Monto total del préstamo a mostrar en el segundo periodo.",example:"$10,000.00"},{id:"loan3",name:"Préstamo Periodo 3",description:"Monto total del préstamo a mostrar en el tercer periodo.",example:"$10,000.00"},{id:"loan4",name:"Préstamo Periodo 4",description:"Monto total del préstamo a mostrar en el cuarto periodo.",example:"$10,000.00"},{id:"loan5",name:"Préstamo Periodo 5",description:"Monto total del préstamo a mostrar en el quinto periodo.",example:"$10,000.00"},{id:"financeAmount1",name:"Monto por financiamiento Periodo 1",description:"Cantidad a cobrar por financiamiento si el cliente reclama la prenda dentro del primer periodo.",example:"$260.00"},{id:"financeAmount2",name:"Monto por financiamiento Periodo 2",description:"Cantidad a cobrar por financiamiento si el cliente reclama la prenda dentro del segundo periodo.",example:"$520.00"},{id:"financeAmount3",name:"Monto por financiamiento Periodo 3",description:"Cantidad a cobrar por financiamiento si el cliente reclama la prenda dentro del tercer periodo.",example:"$780.00"},{id:"financeAmount4",name:"Monto por financiamiento Periodo 4",description:"Cantidad a cobrar por financiamiento si el cliente reclama la prenda dentro del cuarto periodo.",example:"$1,040.00"},{id:"financeAmount5",name:"Monto por financiamiento Periodo 5",description:"Cantidad a cobrar por financiamiento si el cliente reclama la prenda dentro del quinto periodo.",example:"$1,300.00"},{id:"storageAmount1",name:"Monto por almacenaje Periodo 1",description:"Cantidad a cobrar por almacenaje si el cliente reclama la prenda dentro del primer periodo.",example:"$100.00"},{id:"storageAmount2",name:"Monto por almacenaje Periodo 2",description:"Cantidad a cobrar por almacenaje si el cliente reclama la prenda dentro del segundo periodo.",example:"$200.00"},{id:"storageAmount3",name:"Monto por almacenaje Periodo 3",description:"Cantidad a cobrar por almacenaje si el cliente reclama la prenda dentro del tercer periodo.",example:"$300.00"},{id:"storageAmount4",name:"Monto por almacenaje Periodo 4",description:"Cantidad a cobrar por almacenaje si el cliente reclama la prenda dentro del cuarto periodo.",example:"$400.00"},{id:"storageAmount5",name:"Monto por almacenaje Periodo 5",description:"Cantidad a cobrar por almacenaje si el cliente reclama la prenda dentro del quinto periodo.",example:"$500.00"},{id:"vatAmount1",name:"Monto por IVA Periodo 1",description:"Cantidad a cobrar por IVA si el cliente reclama la prenda dentro del primer periodo.",example:"$320.00"},{id:"vatAmount2",name:"Monto por IVA Periodo 2",description:"Cantidad a cobrar por IVA si el cliente reclama la prenda dentro del segundo periodo.",example:"$640.00"},{id:"vatAmount3",name:"Monto por IVA Periodo 3",description:"Cantidad a cobrar por IVA si el cliente reclama la prenda dentro del tercer periodo.",example:"$960.00"},{id:"vatAmount4",name:"Monto por IVA Periodo 4",description:"Cantidad a cobrar por IVA si el cliente reclama la prenda dentro del cuarto periodo.",example:"$1,280.00"},{id:"vatAmount5",name:"Monto por IVA Periodo 5",description:"Cantidad a cobrar por IVA si el cliente reclama la prenda dentro del quinto periodo.",example:"$1,600.00"},{id:"renewal1",name:"Refrendo Periodo 1",description:"Monto a pagar para refrendar al término del primer periodo.",example:"$320.00"},{id:"renewal2",name:"Refrendo Periodo 2",description:"Monto a pagar para refrendar al término del segundo periodo.",example:"$640.00"},{id:"renewal3",name:"Refrendo Periodo 3",description:"Monto a pagar para refrendar al término del tercer periodo.",example:"$960.00"},{id:"renewal4",name:"Refrendo Periodo 4",description:"Monto a pagar para refrendar al término del cuarto periodo.",example:"$1,280.00"},{id:"renewal5",name:"Refrendo Periodo 5",description:"Monto a pagar para refrendar al término del quinto periodo.",example:"$1,600.00"},{id:"claim1",name:"Desempeño Periodo 1",description:"Monto a pagar para desempeñar al término del primer periodo.",example:"$690.00"},{id:"claim2",name:"Desempeño Periodo 2",description:"Monto a pagar para desempeñar al término del segundo periodo.",example:"$1,380.00"},{id:"claim3",name:"Desempeño Periodo 3",description:"Monto a pagar para desempeñar al término del tercer periodo.",example:"$2,070.00"},{id:"claim4",name:"Desempeño Periodo 4",description:"Monto a pagar para desempeñar al término del cuarto periodo.",example:"$2,760.00"},{id:"claim5",name:"Desempeño Periodo 5",description:"Monto a pagar para desempeñar al término del quinto periodo.",example:"$3,450.00"},{id:"expiration1",name:"Fecha de vencimiento Periodo 1",description:"Fecha de término del primer periodo.",example:"17-May-2015"},{id:"expiration2",name:"Fecha de vencimiento Periodo 2",description:"Fecha de término del segundo periodo.",example:"24-May-2015"},{id:"expiration3",name:"Fecha de vencimiento Periodo 3",description:"Fecha de término del tercer periodo.",example:"31-May-2015"},{id:"expiration4",name:"Fecha de vencimiento Periodo 4",description:"Fecha de término del cuarto periodo.",example:"06-Jun-2015"},{id:"expiration5",name:"Fecha de vencimiento Periodo 5",description:"Fecha de término del quinto periodo.",example:"13-Jun-2015"}],getTicket:function(){return a.get("/api/company/ticket")},save:function(e){return a.put("/api/company/ticket",{ticket:e})},removeTemplate:function(){return a.delete("/api/company/ticket/template")},generateTicket:function(e,t){return a.get("/api/branch/"+e+"/loan/"+t+"/ticket")}}}]),angular.module("UserService",[]).factory("User",["$http",function(t){return{info:function(){return t.get("/auth/info")},register:function(e){return t.post("/auth/register",e)},login:function(e){return t.post("/auth/login",e)},verify:function(e){return t.post("/auth/verify",{code:e})},resend:function(e){return t.post("/auth/resend",{email:e})},sendRecoveryEmail:function(e){return t.post("/auth/recover",{email:e})},validateRecoveryToken:function(e){return t.get("/auth/validateRecoveryToken/"+e)},resetPassword:function(e){return t.post("/auth/reset",e)},deleteAccount:function(){return t.delete("/api/user")}}}]);